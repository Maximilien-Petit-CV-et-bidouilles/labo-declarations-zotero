<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi public — HAL & communication</title>

  <style>
    :root{
      --bg:#0b0d10;
      --panel:#12161b;
      --muted:#9aa4b2;
      --text:#e7edf5;
      --border:#222a33;
      --accent:#2c7be5;
      --ok:#1b7c3a;
      --warn:#b26a00;
      --bad:#b32020;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{ color:var(--accent); text-decoration:none; }

    .container{
      max-width:1200px;
      margin:28px auto;
      padding:0 16px;
    }

    header{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      margin-bottom:14px;
    }
    h1{ margin:0 0 6px; font-size:20px; }
    .subtitle{ margin:0; color:var(--muted); font-size:14px; }

    /* === CHARTS === */
    .charts{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
      margin:14px 0 18px;
    }
    .chart-card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .chart-card h2{
      margin:0 0 10px;
      font-size:14px;
      color:var(--muted);
    }

    /* === TABLE === */
    table{
      width:100%;
      border-collapse:collapse;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-size:14px;
    }
    th{ color:var(--muted); font-weight:600; }
    tr:last-child td{ border-bottom:none; }

    .badge{
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      display:inline-block;
    }
    .ok{ background:#163a25; color:#7ce2a3; }
    .warn{ background:#3a2a16; color:#f1c27d; }
    .muted{ background:#222a33; color:#9aa4b2; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Suivi public des demandes</h1>
      <p class="subtitle">
        Déclarations issues du formulaire du laboratoire — suivi des demandes HAL et communication.
      </p>
    </header>

    <!-- === GRAPHIQUES === -->
    <section class="charts">
      <div class="chart-card">
        <h2>Déclarations par année</h2>
        <canvas id="chartByYear"></canvas>
      </div>
      <div class="chart-card">
        <h2>Répartition des demandes</h2>
        <canvas id="chartSplit"></canvas>
      </div>
      <div class="chart-card">
        <h2>Statut de traitement</h2>
        <canvas id="chartStatus"></canvas>
      </div>
    </section>

    <!-- === TABLEAU === -->
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Titre</th>
          <th>Année</th>
          <th>HAL</th>
          <th>Communication</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const API_URL = '/.netlify/functions/public-suivi';
    let charts = [];

    function normalizeBool(v){
      v = String(v || '').toLowerCase();
      if (v === 'yes' || v === 'oui' || v === 'true') return 'yes';
      if (v === 'no' || v === 'non' || v === 'false') return 'no';
      return '';
    }

    function computeStatus(flags){
      const halWanted = normalizeBool(flags?.hal_create) === 'yes';
      const commWanted = normalizeBool(flags?.comms_publish) === 'yes';
      const halDone = normalizeBool(flags?.hal_done) === 'yes';
      const commDone = normalizeBool(flags?.comms_done) === 'yes';

      if (!halWanted && !commWanted) return 'Non demandé';
      if ((halWanted && !halDone) || (commWanted && !commDone)) return 'À traiter';
      return 'Traité';
    }

    function badge(label, cls){
      return `<span class="badge ${cls}">${label}</span>`;
    }

    function destroyCharts(){
      charts.forEach(c => c.destroy());
      charts = [];
    }

    function renderCharts(items){
      destroyCharts();

      /* === par année === */
      const byYear = {};
      items.forEach(i => {
        const y = i.year || '—';
        byYear[y] = (byYear[y] || 0) + 1;
      });
      const years = Object.keys(byYear).sort();
      const yearCounts = years.map(y => byYear[y]);

      /* === répartition demandes === */
      let halOnly=0, commOnly=0, both=0, none=0;
      items.forEach(i => {
        const f = i.flags || {};
        const h = normalizeBool(f.hal_create)==='yes';
        const c = normalizeBool(f.comms_publish)==='yes';
        if (h && c) both++;
        else if (h) halOnly++;
        else if (c) commOnly++;
        else none++;
      });

      /* === statut global === */
      const statusCounts = { 'À traiter':0, 'Traité':0, 'Non demandé':0 };
      items.forEach(i => statusCounts[computeStatus(i.flags||{})]++);

      charts.push(new Chart(chartByYear, {
        type:'bar',
        data:{ labels:years, datasets:[{ data:yearCounts }] },
        options:{ plugins:{ legend:{ display:false } } }
      }));

      charts.push(new Chart(chartSplit, {
        type:'doughnut',
        data:{
          labels:['HAL seul','Com seule','HAL + Com','Aucune'],
          datasets:[{ data:[halOnly,commOnly,both,none] }]
        }
      }));

      charts.push(new Chart(chartStatus, {
        type:'doughnut',
        data:{
          labels:['À traiter','Traité','Non demandé'],
          datasets:[{ data:[
            statusCounts['À traiter'],
            statusCounts['Traité'],
            statusCounts['Non demandé']
          ]}]
        }
      }));
    }

    function renderTable(items){
      rows.innerHTML = items.map(i => {
        const status = computeStatus(i.flags||{});
        return `<tr>
          <td>${i.itemType === 'book' ? 'Livre' : 'Chapitre'}</td>
          <td>${i.title || ''}</td>
          <td>${i.year || ''}</td>
          <td>${normalizeBool(i.flags?.hal_create)==='yes' ? 'Oui' : '—'}</td>
          <td>${normalizeBool(i.flags?.comms_publish)==='yes' ? 'Oui' : '—'}</td>
          <td>${
            status==='Traité' ? badge('Traité','ok') :
            status==='À traiter' ? badge('À traiter','warn') :
            badge('Non demandé','muted')
          }</td>
        </tr>`;
      }).join('');
    }

    async function load(){
      const r = await fetch(API_URL);
      const data = await r.json();
      renderCharts(data.items);
      renderTable(data.items);
    }

    load();
  </script>
</body>
</html>
