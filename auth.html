<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connexion / Activation</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:40px;max-width:780px}
    .muted{color:#666}
    button{font:inherit;padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button.primary{background:#2c7be5;color:#fff;border-color:#2c7be5;font-weight:650}
    code{background:#f2f2f6;padding:2px 6px;border-radius:6px}
    /* FIX: certaines configs/browsers finissent avec le widget cachÃ© */
    .netlify-identity-widget, .netlify-identity-widget iframe{
      display:block !important;
      visibility:visible !important;
      opacity:1 !important;
    }
    .netlify-identity-widget{
      position:fixed !important;
      inset:0 !important;
      z-index:999999 !important;
    }
  </style>
</head>
<body>
  <h1>Connexion / Activation du compte</h1>
  <p class="muted">
    Si vous venez dâ€™un lien dâ€™invitation, lâ€™URL contient un <code>#invite_token=â€¦</code>.
    La fenÃªtre doit sâ€™ouvrir automatiquement.
  </p>

  <p>
    <button id="open" class="primary">Ouvrir la fenÃªtre</button>
  </p>

  <p id="diag" class="muted"></p>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    const diag = document.getElementById('diag');

    function hasToken(){
      const h = window.location.hash || "";
      return h.includes("invite_token=") ||
             h.includes("confirmation_token=") ||
             h.includes("recovery_token=") ||
             h.includes("email_change_token=") ||
             h.includes("access_token=");
    }

    function openSignup(){
      if (!window.netlifyIdentity) {
        diag.textContent = "âŒ netlifyIdentity indisponible (script bloquÃ© ? anti-tracking ?).";
        return;
      }
      // IMPORTANT: 'signup' est souvent plus fiable pour les invites
      window.netlifyIdentity.open('signup');
      // Double tap (certains navigateurs cachent le widget Ã  lâ€™ouverture)
      setTimeout(() => window.netlifyIdentity.open('signup'), 400);
    }

    document.getElementById('open').addEventListener('click', openSignup);

    if (!window.netlifyIdentity) {
      diag.textContent = "âŒ Le widget Identity ne se charge pas. Essaie de dÃ©sactiver le bloqueur / anti-tracking pour ce site.";
    } else {
      window.netlifyIdentity.on("init", (user) => {
        const h = window.location.hash || "";
        diag.textContent = user
          ? "âœ… DÃ©jÃ  connectÃ©."
          : ("ðŸ”Ž Hash dÃ©tectÃ©: " + (h ? h.slice(0, 60) + "â€¦" : "(vide)"));

        if (!user && hasToken()) openSignup();
      });

      window.netlifyIdentity.on("login", () => {
        window.netlifyIdentity.close();
        window.location.href = "/admin.html";
      });

      window.netlifyIdentity.init();
    }
  </script>
</body>
</html>
