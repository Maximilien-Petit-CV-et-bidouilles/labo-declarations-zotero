<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Générateur de CV – Laboratoire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5f5f8; --card:#fff; --accent:#2c7be5;
      --accent-soft:#e1ecff; --text:#222; --muted:#666; --border:#ddd;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .page{max-width:1000px;margin:32px auto;padding:0 16px}
    header{margin-bottom:18px}
    h1{margin:0 0 6px;font-size:1.7rem;font-weight:650}
    .subtitle{margin:0;color:var(--muted);font-size:.95rem}

    .grid{display:grid;grid-template-columns: 360px 1fr; gap:16px}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
    }
    .card h2{margin:0 0 10px;font-size:1.05rem}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 520px){ .row{grid-template-columns:1fr} }

    label{display:block;font-weight:650;font-size:.9rem;margin:0 0 10px}
    label span{display:block;margin:0 0 4px;color:var(--muted);font-weight:600;font-size:.85rem}
    input,select,textarea{
      width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);
      font:inherit;background:#fff
    }
    textarea{resize:vertical; min-height:120px}

    .btnbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    button{
      border-radius:999px;border:1px solid var(--border);background:#fff;
      padding:8px 12px;cursor:pointer;font-weight:650
    }
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    button:disabled{opacity:.6;cursor:default}

    .hint{color:var(--muted);font-size:.9rem;margin:10px 0 0}

    /* CV preview */
    .cv{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:18px;
    }
    .cv .cv-title{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .cv .cv-title h2{margin:0;font-size:1.35rem}
    .cv small{color:var(--muted)}
    .section{margin-top:16px;padding-top:14px;border-top:1px solid var(--border)}
    .section h3{margin:0 0 8px;font-size:1.05rem}

    .editable{
      border:1px dashed transparent;
      border-radius:10px;
      padding:8px;
      min-height:44px;
    }
    .editable:focus{
      outline:none;
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .pubs{margin:0;padding-left:18px}
    .pubs li{margin:0 0 8px;line-height:1.35}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      font-size:.8rem;color:var(--muted);
      border:1px solid var(--border);
      border-radius:999px;padding:3px 8px;
      margin-left:8px;
    }

    .status{margin-top:10px;font-size:.9rem;white-space:pre-wrap}
    .status.ok{color:#1b7c3a}
    .status.err{color:#b32020}

    /* -------- Markdown blocks (Option 2a) -------- */
    .mdblock{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .mdtabs{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .mdtabs .tab{
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px;
      cursor:pointer;
      font-weight:650;
      font-size:.85rem;
    }
    .mdtabs .tab.active{
      border-color:var(--accent);
      background:var(--accent-soft);
    }
    .mdtabs .mdhint{
      color:var(--muted);
      font-size:.85rem;
      margin-left:auto;
    }
    .mdedit{
      width:100%;
      min-height:120px;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      font:inherit;
      background:#fff;
      line-height:1.35;
    }
    .mdpreview{
      padding:8px 2px;
      line-height:1.45;
    }
    .mdpreview :is(p, ul, ol){ margin:0 0 8px; }
    .mdpreview :is(ul, ol){ padding-left:20px; }
    .mdpreview h1, .mdpreview h2, .mdpreview h3{ margin:10px 0 6px; }
    .mdpreview a{ color:var(--accent); text-decoration:none; }
    .mdpreview a:hover{ text-decoration:underline; }
    .mdpreview code{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.9em;
      background:#f2f4f7;
      padding:1px 6px;
      border-radius:999px;
      border:1px solid var(--border);
    }

    /* Print fallback minimal (PDF “propre” via html2pdf.js) */
    @media print{
      body{background:#fff}
      .page{margin:0;max-width:none}
      .grid{grid-template-columns:1fr}
      .card{display:none}
      .cv{border:none}
      .mdtabs{display:none}
      .mdedit{display:none}
      .mdpreview{display:block !important}
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Générateur de CV</h1>
      <p class="subtitle">Le CV est généré à partir des publications déclarées (Zotero). Les sections texte sont en Markdown (mode Éditer/Aperçu).</p>
      <p style="margin-top:8px;font-size:.9rem">
        ⬅️ <a href="/" style="color:var(--accent);text-decoration:none;font-weight:650">Retour</a>
      </p>
    </header>

    <div class="grid">
      <!-- LEFT: Controls -->
      <section class="card">
        <h2>Paramètres</h2>

        <label>
          <span>Auteur (filtre)</span>
          <input id="authorFilter" placeholder="ex : Dupont, Jean / Jean Dupont / DUPONT">
        </label>

        <div class="row">
          <label>
            <span>Année (min)</span>
            <input id="yearMin" inputmode="numeric" placeholder="2018">
          </label>
          <label>
            <span>Année (max)</span>
            <input id="yearMax" inputmode="numeric" placeholder="2026">
          </label>
        </div>

        <label>
          <span>Inclure seulement les items “Publication”</span>
          <select id="onlyPublications">
            <option value="yes" selected>Oui (book / bookSection / journalArticle)</option>
            <option value="no">Non (tout ce qui est listé)</option>
          </select>
        </label>

        <label>
          <span>Trier</span>
          <select id="sortMode">
            <option value="date_desc" selected>Date décroissante</option>
            <option value="date_asc">Date croissante</option>
            <option value="title_asc">Titre A→Z</option>
          </select>
        </label>

        <div class="btnbar">
          <button class="primary" id="refreshBtn">Rafraîchir (Zotero)</button>
          <button id="saveTextBtn">Sauver les textes</button>
        </div>

        <div class="btnbar" style="margin-top:8px">
          <button id="exportHtmlBtn">Exporter HTML</button>
          <button id="exportPdfBtn">Exporter PDF (propre)</button>
          <button id="exportDocxBtn">Exporter DOCX</button>
        </div>

        <p class="hint">
          ✍️ Les blocs texte utilisent du Markdown : <code>**gras**</code>, <code>*italique*</code>, listes (<code>- item</code>), liens (<code>[texte](url)</code>).
          Clique “Aperçu” pour voir le rendu, “Sauver les textes” pour conserver dans le navigateur.
        </p>

        <p id="cv-status" class="status"></p>
      </section>

      <!-- RIGHT: CV -->
      <main class="cv" id="cvRoot">
        <div class="cv-title">
          <div>
            <h2 contenteditable="true" class="editable" id="cvName" data-key="cv.name">Nom Prénom</h2>
            <small contenteditable="true" class="editable" id="cvContact" data-key="cv.contact">Email · Affiliation · Site web</small>
          </div>
          <small id="cvMeta"></small>
        </div>

        <!-- Markdown block: Présentation -->
        <section class="section">
          <h3>Présentation</h3>
          <div class="mdblock" data-md-key="cv.presentation" data-md-default="Je suis…&#10;&#10;- Thématique 1&#10;- Thématique 2&#10;&#10;[Mon site](https://exemple.fr)">
            <div class="mdtabs">
              <button class="tab active" type="button" data-tab="preview">Aperçu</button>
              <button class="tab" type="button" data-tab="edit">Éditer</button>
              <span class="mdhint">Markdown</span>
            </div>
            <textarea class="mdedit" hidden></textarea>
            <div class="mdpreview"></div>
          </div>
        </section>

        <!-- Markdown block: Titres -->
        <section class="section">
          <h3>Titres et fonctions</h3>
          <div class="mdblock" data-md-key="cv.titles" data-md-default="- Ingénieur d’études (IGE)&#10;- Appui aux projets de recherche">
            <div class="mdtabs">
              <button class="tab active" type="button" data-tab="preview">Aperçu</button>
              <button class="tab" type="button" data-tab="edit">Éditer</button>
              <span class="mdhint">Markdown</span>
            </div>
            <textarea class="mdedit" hidden></textarea>
            <div class="mdpreview"></div>
          </div>
        </section>

        <!-- Markdown block: Diplômes -->
        <section class="section">
          <h3>Principaux diplômes</h3>
          <div class="mdblock" data-md-key="cv.degrees" data-md-default="- Master … (année, établissement)&#10;- Licence … (année, établissement)">
            <div class="mdtabs">
              <button class="tab active" type="button" data-tab="preview">Aperçu</button>
              <button class="tab" type="button" data-tab="edit">Éditer</button>
              <span class="mdhint">Markdown</span>
            </div>
            <textarea class="mdedit" hidden></textarea>
            <div class="mdpreview"></div>
          </div>
        </section>

        <!-- Publications (Zotero) -->
        <section class="section">
          <h3>Productions principales en recherche</h3>
          <div style="margin:4px 0 10px;color:var(--muted);font-size:.9rem">
            Bibliographie formatée (côté navigateur).
            <span class="pill" id="pubCount">0 référence</span>
          </div>
          <ol class="pubs" id="pubList"></ol>
        </section>

        <!-- Markdown block: Teaching -->
        <section class="section">
          <h3>Investissement pédagogique et diffusion de la connaissance</h3>
          <div class="mdblock" data-md-key="cv.teaching" data-md-default="- Cours / interventions…&#10;- Vulgarisation / diffusion…">
            <div class="mdtabs">
              <button class="tab active" type="button" data-tab="preview">Aperçu</button>
              <button class="tab" type="button" data-tab="edit">Éditer</button>
              <span class="mdhint">Markdown</span>
            </div>
            <textarea class="mdedit" hidden></textarea>
            <div class="mdpreview"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- libs (client-side only) -->
  <script src="https://unpkg.com/citeproc@2.4.63/citeproc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>

  <!-- PDF "propre" (html2canvas + jsPDF) -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <!-- app -->
  <script src="assets/cv.js"></script>
</body>
</html>
