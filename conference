<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Déclarations – Communication (Conference Paper)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5f5f8; --card:#fff; --accent:#2c7be5; --accent-soft:#e1ecff;
      --text:#222; --muted:#666; --border:#ddd; --ok:#1b7c3a; --bad:#b32020;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .page{max-width:980px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px}
    h1{margin:0;font-size:1.45rem}
    .sub{margin:6px 0 0;color:var(--muted);font-size:.92rem}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:.85rem;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 760px){ .row{grid-template-columns:1fr} }
    label{display:block}
    label .lab{display:block;color:var(--muted);font-weight:650;margin:0 0 6px;font-size:.85rem}
    input,select,textarea,button{font:inherit}
    input,select,textarea{
      width:100%;padding:10px 10px;border-radius:10px;border:1px solid var(--border);background:#fff
    }
    textarea{resize:vertical}
    .authorsHead{margin:10px 0 6px;font-weight:750}
    .authorRow{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;margin-bottom:8px}
    @media (max-width: 760px){ .authorRow{grid-template-columns:1fr 1fr} .authorRow button{grid-column:1 / -1} }
    .btn{
      padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:650
    }
    .btn.danger{border-color:rgba(179,32,32,.35);color:var(--bad)}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:750}
    .small{color:var(--muted);font-size:.85rem}
    .sectionTitle{margin:14px 0 8px;font-size:1rem;font-weight:800}
    .checks{display:flex;gap:10px;flex-wrap:wrap}
    .check{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 10px;border-radius:999px;background:#fff}
    .check input{width:auto}
    .status{margin-top:10px;color:var(--muted);font-size:.92rem;white-space:pre-wrap}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--bad)}
    a{color:inherit}
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div>
        <h1>Nouvelle communication — Conference Paper</h1>
        <p class="sub">Création d’une notice Zotero (itemType: <b>conferencePaper</b>) + options HAL / Communication + axes + champs <code>tex.*</code> dans Extra.</p>
      </div>
      <div class="pill">
        <a href="index.html">← Retour “Nouvelle publication”</a>
      </div>
    </header>

    <div class="card">
      <form id="confForm">
        <label>
          <span class="lab">Title *</span>
          <input name="title" required />
        </label>

        <div class="authorsHead">Author(s) *</div>
        <div id="authors"></div>
        <div style="display:flex;gap:8px;align-items:center;margin:6px 0 12px;flex-wrap:wrap">
          <button type="button" class="btn" id="addAuthor">+ Ajouter un auteur</button>
          <span class="small">Minimum : 1 auteur (Nom requis)</span>
        </div>

        <div class="row">
          <label>
            <span class="lab">Conference Name *</span>
            <input name="conferenceName" required />
          </label>
          <label>
            <span class="lab">Date *</span>
            <input name="date" placeholder="2015 ou 2015-06-15" required />
          </label>
        </div>

        <div class="row">
          <label>
            <span class="lab">Publisher</span>
            <input name="publisher" />
          </label>
          <label>
            <span class="lab">Place</span>
            <input name="place" />
          </label>
        </div>

        <label>
          <span class="lab">Language</span>
          <input name="language" placeholder="fr / en" />
        </label>

        <div class="sectionTitle">Extra (tex.*)</div>

        <div class="row">
          <label>
            <span class="lab">tex.conferencestartdate</span>
            <input name="tex_conferencestartdate" placeholder="2015-06-01" />
          </label>
          <label>
            <span class="lab">tex.conferenceenddate</span>
            <input name="tex_conferenceenddate" placeholder="2015-06-03" />
          </label>
        </div>

        <label>
          <span class="lab">tex.conferenceorganizer</span>
          <input name="tex_conferenceorganizer" />
        </label>

        <div class="row">
          <label>
            <span class="lab">tex.x-audience</span>
            <input name="tex_x_audience" value="Not set" />
          </label>
          <label>
            <span class="lab">tex.x-language</span>
            <input name="tex_x_language" placeholder="fr / en" />
          </label>
        </div>

        <div class="row">
          <label>
            <span class="lab">tex.x-invitedcommunication</span>
            <select name="tex_x_invitedcommunication">
              <option value="">—</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </label>
          <label>
            <span class="lab">tex.x-peerreviewing</span>
            <select name="tex_x_peerreviewing">
              <option value="">—</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </label>
        </div>

        <div class="row">
          <label>
            <span class="lab">tex.x-popularlevel</span>
            <select name="tex_x_popularlevel">
              <option value="">—</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </label>
          <label>
            <span class="lab">tex.x-proceedings</span>
            <select name="tex_x_proceedings">
              <option value="">—</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </label>
        </div>

        <div class="sectionTitle">Options</div>

        <div class="row">
          <label>
            <span class="lab">Souhaitez-vous la création d’une notice sur HAL ? *</span>
            <select name="optHal" required>
              <option value="">—</option>
              <option value="yes">Oui</option>
              <option value="no">Non</option>
            </select>
          </label>
          <label>
            <span class="lab">Souhaitez-vous une communication (newsletter + réseaux sociaux) ? *</span>
            <select name="optComms" required>
              <option value="">—</option>
              <option value="yes">Oui</option>
              <option value="no">Non</option>
            </select>
          </label>
        </div>

        <div style="margin-top:10px">
          <div class="lab" style="display:block;margin:0 0 6px">Axes (facultatif)</div>
          <div class="checks">
            <label class="check"><input type="checkbox" name="axisPICMAP" value="PICMAP"> PICMAP</label>
            <label class="check"><input type="checkbox" name="axisMOPTIS" value="MOPTIS"> MOPTIS</label>
            <label class="check"><input type="checkbox" name="axisOCSO" value="OCSO"> OCSO</label>
          </div>
        </div>

        <label style="margin-top:10px">
          <span class="lab">Extra (texte libre)</span>
          <textarea name="extra" rows="4" placeholder="Infos internes… (sera conservé, puis complété automatiquement)"></textarea>
        </label>

        <button class="btn primary" type="submit" id="submitBtn">Envoyer vers Zotero</button>
        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setStatus(msg, kind){
      const el = $('status');
      el.textContent = msg || '';
      el.className = 'status' + (kind ? (' ' + kind) : '');
    }

    function addAuthor(firstName='', lastName=''){
      const wrap = document.createElement('div');
      wrap.className = 'authorRow';
      wrap.innerHTML = `
        <input placeholder="Prénom" value="${escapeHtml(firstName)}">
        <input placeholder="Nom *" value="${escapeHtml(lastName)}">
        <button type="button" class="btn danger">Supprimer</button>
      `;
      wrap.querySelector('button').addEventListener('click', () => wrap.remove());
      $('authors').appendChild(wrap);
    }

    function getAuthors(){
      const rows = Array.from(document.querySelectorAll('#authors .authorRow'));
      const authors = rows.map(r => {
        const inputs = r.querySelectorAll('input');
        return { firstName: (inputs[0].value||'').trim(), lastName: (inputs[1].value||'').trim() };
      }).filter(a => a.firstName || a.lastName);
      return authors;
    }

    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function axesFromForm(f){
      const axes = [];
      if (f.axisPICMAP.checked) axes.push('PICMAP');
      if (f.axisMOPTIS.checked) axes.push('MOPTIS');
      if (f.axisOCSO.checked) axes.push('OCSO');
      return axes;
    }

    function buildExtraDLAB(userExtra, optHal, optComms, axesArr){
      const base = (userExtra || '').trim();
      const axes = axesArr && axesArr.length ? axesArr.join(',') : 'none';
      const block =
`[DLAB]
hal_create: ${optHal}
comms_publish: ${optComms}
axes: ${axes}
[/DLAB]`;
      return base ? (base + "\n\n" + block) : block;
    }

    function appendTex(extraBase, texMap){
      const base = (extraBase || '').trim();
      const lines = [];
      for (const [k,v] of Object.entries(texMap||{})){
        const key = String(k||'').trim();
        const val = String(v||'').trim();
        if (!key || !val) continue;
        lines.push(`${key}: ${val}`);
      }
      if (!lines.length) return base;
      return base ? (base + "\n\n" + lines.join("\n")) : lines.join("\n");
    }

    // init authors
    $('addAuthor').addEventListener('click', () => addAuthor());
    addAuthor();

    $('confForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.target;

      const submitBtn = $('submitBtn');
      submitBtn.disabled = true;
      setStatus('⏳ Envoi vers Zotero…');

      try{
        const authors = getAuthors();
        if (!authors.length || !authors.some(a => (a.lastName||'').trim())){
          setStatus('❌ Merci de renseigner au moins un auteur (Nom requis).', 'err');
          submitBtn.disabled = false;
          return;
        }

        const title = (f.title.value||'').trim();
        const conferenceName = (f.conferenceName.value||'').trim();
        const date = (f.date.value||'').trim();
        if (!title || !conferenceName || !date){
          setStatus('❌ Champs obligatoires manquants (Title / Conference Name / Date).', 'err');
          submitBtn.disabled = false;
          return;
        }

        const optHal = (f.optHal.value||'').trim();
        const optComms = (f.optComms.value||'').trim();
        if (!optHal || !optComms){
          setStatus('❌ Merci de répondre aux 2 questions (HAL + communication).', 'err');
          submitBtn.disabled = false;
          return;
        }

        const axes = axesFromForm(f);

        let extra = buildExtraDLAB((f.extra.value||''), optHal, optComms, axes);

        const texMap = {
          'tex.conferenceenddate': f.tex_conferenceenddate.value,
          'tex.conferenceorganizer': f.tex_conferenceorganizer.value,
          'tex.conferencestartdate': f.tex_conferencestartdate.value,
          'tex.x-audience': f.tex_x_audience.value || 'Not set',
          'tex.x-invitedcommunication': f.tex_x_invitedcommunication.value,
          'tex.x-language': f.tex_x_language.value,
          'tex.x-peerreviewing': f.tex_x_peerreviewing.value,
          'tex.x-popularlevel': f.tex_x_popularlevel.value,
          'tex.x-proceedings': f.tex_x_proceedings.value
        };
        extra = appendTex(extra, texMap);

        const payload = {
          kind: 'publication',
          pubType: 'conferencePaper',
          title,
          authors,
          conferenceName,
          publisher: (f.publisher.value||'').trim(),
          place: (f.place.value||'').trim(),
          date,
          language: (f.language.value||'').trim(),
          extra
        };

        const r = await fetch('/.netlify/functions/zotero-create-item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const t = await r.text();
        if (!r.ok){
          setStatus(`❌ Erreur Zotero (${r.status}) : ${t}`, 'err');
          submitBtn.disabled = false;
          return;
        }

        setStatus('✅ Notice créée dans Zotero.', 'ok');
        f.reset();
        $('authors').innerHTML = '';
        addAuthor();
        f.tex_x_audience.value = 'Not set';
      } catch(err){
        console.error(err);
        setStatus('❌ Erreur : ' + (err?.message || err), 'err');
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
