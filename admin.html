<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Back-office — Suivi HAL / Communication</title>
  <style>
    :root{
      --bg:#f5f5f8; --card:#fff; --text:#222; --muted:#666; --border:#ddd;
      --accent:#2c7be5; --ok:#1b7c3a; --warn:#b26a00; --bad:#b32020;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1150px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:1.35rem}
    .sub{margin:6px 0 0;color:var(--muted);font-size:.92rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button,select{
      font:inherit;padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:#fff
    }
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:650}
    button.danger{background:#fff;border-color:rgba(179,32,32,.5);color:var(--bad);font-weight:650}
    .msg{margin-top:10px;color:var(--muted);font-size:.9rem;white-space:pre-wrap}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.82rem;color:var(--muted);text-align:left;white-space:nowrap}
    td{font-size:.92rem}
    .title{font-weight:650}
    .mini{font-size:.82rem;color:var(--muted);margin-top:4px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:.82rem;background:#fff;white-space:nowrap}
    .tag.ok{border-color:rgba(27,124,58,.35);background:rgba(27,124,58,.08);color:var(--ok)}
    .tag.warn{border-color:rgba(178,106,0,.35);background:rgba(178,106,0,.08);color:var(--warn)}
    .tag.bad{border-color:rgba(179,32,32,.35);background:rgba(179,32,32,.08);color:var(--bad)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chk{display:flex;gap:8px;align-items:center}
    .chk input{width:18px;height:18px;padding:0}
    .right{white-space:nowrap}
    .small{font-size:.85rem;color:var(--muted)}
    .sticky{position:sticky;top:0;background:var(--bg);padding:10px 0;z-index:5}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Back-office — Suivi HAL & Communication</h1>
        <p class="sub">Page privée (token). Met à jour le champ “Extra” dans Zotero (hal_done / comms_done).</p>
      </div>
      <div class="row">
        <button id="refresh" class="primary">Rafraîchir</button>
        <button id="logout" class="danger">Déconnexion</button>
      </div>
    </header>

    <div class="card sticky">
      <div class="row">
        <input id="token" type="password" placeholder="ADMIN_TOKEN" style="min-width:260px" />
        <button id="saveToken" class="primary">Se connecter</button>
        <span class="small">Le token est stocké dans ce navigateur (localStorage).</span>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="q" type="search" placeholder="Rechercher (titre, auteur, éditeur…)" style="flex:1;min-width:240px" />
        <select id="filterNeed">
          <option value="all">Tout</option>
          <option value="needsAction">À traiter</option>
          <option value="hal">HAL demandé</option>
          <option value="comms">Com demandée</option>
        </select>
        <select id="filterType">
          <option value="all">Tous types</option>
          <option value="book">Livres</option>
          <option value="bookSection">Chapitres</option>
        </select>
      </div>

      <div class="msg" id="msg"></div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width:80px">Année</th>
            <th style="width:90px">Type</th>
            <th>Titre</th>
            <th style="width:230px">Auteur(s)</th>
            <th style="width:170px">HAL</th>
            <th style="width:200px">Communication</th>
            <th style="width:210px">Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="7" class="small">Connecte-toi avec le token puis “Rafraîchir”.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let ALL = [];

    const $ = (id) => document.getElementById(id);

    function norm(s){
      return (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }
    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function typeLabel(t){
      if (t === 'book') return 'Livre';
      if (t === 'bookSection') return 'Chapitre';
      return t || '';
    }
    function yearFromDate(dateStr){
      const m = String(dateStr || '').match(/\b(19|20)\d{2}\b/);
      return m ? m[0] : '';
    }
    function statusFor(flags){
      const halWanted = flags?.hal_create === 'yes';
      const commWanted = flags?.comms_publish === 'yes';
      const halDone = flags?.hal_done === 'yes';
      const commDone = flags?.comms_done === 'yes';
      if (!halWanted && !commWanted) return {txt:'Non demandé', cls:''};
      const needHal = halWanted && !halDone;
      const needCom = commWanted && !commDone;
      if (needHal || needCom) return {txt:'À traiter', cls:'warn'};
      return {txt:'Traité', cls:'ok'};
    }

    function setMsg(t){ $('msg').textContent = t || ''; }

    function getToken(){
      const t = $('token').value.trim() || localStorage.getItem('ADMIN_TOKEN') || '';
      return t;
    }
    function saveToken(){
      const t = $('token').value.trim();
      if (!t) { setMsg('Token vide.'); return; }
      localStorage.setItem('ADMIN_TOKEN', t);
      setMsg('✅ Token enregistré. Clique “Rafraîchir”.');
    }
    function logout(){
      localStorage.removeItem('ADMIN_TOKEN');
      $('token').value = '';
      ALL = [];
      $('rows').innerHTML = `<tr><td colspan="7" class="small">Déconnecté.</td></tr>`;
      setMsg('Déconnecté.');
    }

    async function load(){
      const token = getToken();
      if (!token) { setMsg('Entre le token puis “Se connecter”.'); return; }

      setMsg('⏳ Chargement…');
      $('rows').innerHTML = `<tr><td colspan="7" class="small">Chargement…</td></tr>`;

      const r = await fetch('/.netlify/functions/admin-items', {
        headers: { 'X-Admin-Token': token },
        cache: 'no-store'
      });

      const data = await r.json().catch(()=>({}));

      if (!r.ok) {
        $('rows').innerHTML = `<tr><td colspan="7" class="small">Erreur: ${escapeHtml(data?.error || 'accès refusé')}</td></tr>`;
        setMsg('❌ Accès refusé ou erreur serveur.');
        return;
      }

      ALL = (data.items || []).map(it => ({
        ...it,
        year: it.year || yearFromDate(it.date),
        creatorsText: it.creatorsText || ''
      }));

      setMsg(`✅ ${ALL.length} item(s) chargés. (Dernière sync: ${new Date(data.fetchedAt).toLocaleString('fr-FR')})`);
      render();
    }

    function render(){
      const q = norm($('q').value);
      const fNeed = $('filterNeed').value;
      const fType = $('filterType').value;

      const rows = ALL.filter(it => {
        if (fType !== 'all' && it.itemType !== fType) return false;

        const flags = it.flags || {};
        const st = statusFor(flags);

        if (fNeed === 'needsAction' && st.txt !== 'À traiter') return false;
        if (fNeed === 'hal' && flags.hal_create !== 'yes') return false;
        if (fNeed === 'comms' && flags.comms_publish !== 'yes') return false;

        if (!q) return true;
        const hay = norm([it.title, it.bookTitle, it.publisher, it.place, it.isbn, it.creatorsText].filter(Boolean).join(' | '));
        return hay.includes(q);
      });

      rows.sort((a,b) => {
        const ay = parseInt(a.year || '0',10);
        const by = parseInt(b.year || '0',10);
        if (by !== ay) return by - ay;
        return (b.date || '').localeCompare(a.date || '');
      });

      const tbody = $('rows');
      tbody.innerHTML = '';

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="7" class="small">Aucun résultat.</td></tr>`;
        return;
      }

      for (const it of rows){
        const flags = it.flags || {};
        const st = statusFor(flags);

        const halWanted = flags.hal_create === 'yes';
        const commWanted = flags.comms_publish === 'yes';

        const halDone = flags.hal_done === 'yes';
        const commDone = flags.comms_done === 'yes';

        const halTag = halWanted ? (halDone ? 'Demandé (traité)' : 'Demandé') : 'Non';
        const commTag = commWanted ? (commDone ? 'Demandé (traité)' : 'Demandé') : 'Non';

        const tr = document.createElement('tr');

        const titleLine = it.title || '(sans titre)';
        const inBook = it.bookTitle ? `<div class="mini">Dans : ${escapeHtml(it.bookTitle)}</div>` : '';

        tr.innerHTML = `
          <td class="right">${escapeHtml(it.year || '')}</td>
          <td><span class="tag">${escapeHtml(typeLabel(it.itemType))}</span></td>
          <td>
            <div class="title">${escapeHtml(titleLine)}</div>
            ${inBook}
            <div class="mini">${escapeHtml(it.publisher || '')}${it.publisher && it.place ? ' — ' : ''}${escapeHtml(it.place || '')}${it.isbn ? ' — ISBN ' + escapeHtml(it.isbn) : ''}</div>
          </td>
          <td>${escapeHtml(it.creatorsText || '')}</td>
          <td>
            <div class="tag ${halWanted ? 'warn' : ''}">${escapeHtml(halTag)}</div>
            ${halWanted ? `
              <div class="chk mini" style="margin-top:8px">
                <input type="checkbox" data-k="${it.key}" data-field="hal_done" ${halDone ? 'checked' : ''}/>
                <span>HAL traité</span>
              </div>` : `<div class="mini muted">—</div>`}
          </td>
          <td>
            <div class="tag ${commWanted ? 'warn' : ''}">${escapeHtml(commTag)}</div>
            ${commWanted ? `
              <div class="chk mini" style="margin-top:8px">
                <input type="checkbox" data-k="${it.key}" data-field="comms_done" ${commDone ? 'checked' : ''}/>
                <span>Com traitée</span>
              </div>` : `<div class="mini muted">—</div>`}
          </td>
          <td>
            <div class="actions">
              <button class="primary" data-save="${it.key}">Enregistrer</button>
              <span class="tag ${st.cls}">${escapeHtml(st.txt)}</span>
            </div>
            <div class="mini muted">Key: ${escapeHtml(it.key)}</div>
          </td>
        `;

        tbody.appendChild(tr);
      }

      // wire save buttons
      tbody.querySelectorAll('button[data-save]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const key = btn.getAttribute('data-save');
          await saveRow(key, btn);
        });
      });
    }

    async function saveRow(key, btn){
      const token = getToken();
      if (!token) { setMsg('Token manquant.'); return; }

      const checks = [...document.querySelectorAll(`input[type="checkbox"][data-k="${key}"]`)];
      const payload = { key };

      for (const c of checks){
        const field = c.getAttribute('data-field');
        payload[field] = c.checked ? 'yes' : 'no';
      }

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Enregistrement…';
      setMsg('⏳ Mise à jour Zotero…');

      try{
        const r = await fetch('/.netlify/functions/admin-update-status', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify(payload)
        });

        const data = await r.json().catch(()=>({}));

        if (!r.ok){
          setMsg('❌ Erreur: ' + (data?.error || 'mise à jour impossible'));
        } else {
          setMsg('✅ Mis à jour. Rafraîchis pour voir le public à jour.');
          // reload list to show updated flags
          await load();
        }
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    // init token field
    const saved = loca
