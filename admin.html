<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Back-office ‚Äî Suivi HAL / Communication</title>
  <style>
    :root{--bg:#f5f5f8;--card:#fff;--text:#222;--muted:#666;--border:#ddd;--accent:#2c7be5;--ok:#1b7c3a;--warn:#b26a00;--bad:#b32020;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1150px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:1.35rem}
    .sub{margin:6px 0 0;color:var(--muted);font-size:.92rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button,select{font:inherit;padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:#fff}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:650}
    button.danger{background:#fff;border-color:rgba(179,32,32,.5);color:var(--bad);font-weight:650}
    .msg{margin-top:10px;color:var(--muted);font-size:.9rem;white-space:pre-wrap}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.82rem;color:var(--muted);text-align:left;white-space:nowrap}
    td{font-size:.92rem}
    .title{font-weight:650}
    .mini{font-size:.82rem;color:var(--muted);margin-top:4px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:.82rem;background:#fff;white-space:nowrap}
    .tag.ok{border-color:rgba(27,124,58,.35);background:rgba(27,124,58,.08);color:var(--ok)}
    .tag.warn{border-color:rgba(178,106,0,.35);background:rgba(178,106,0,.08);color:var(--warn)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chk{display:flex;gap:8px;align-items:center}
    .chk input{width:18px;height:18px;padding:0}
    .right{white-space:nowrap}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Back-office ‚Äî Suivi HAL & Communication</h1>
        <p class="sub">Connexion via Netlify Identity. Mise √† jour des flags dans Zotero (Extra ‚Üí bloc [DLAB]).</p>
      </div>
      <div class="row">
        <button id="login" class="primary">Se connecter</button>
        <button id="logout" class="danger hidden">Se d√©connecter</button>
        <button id="refresh" class="primary hidden">Rafra√Æchir</button>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <input id="q" class="hidden" type="search" placeholder="Rechercher (titre, auteur, revue, √©diteur, ISBN, DOI‚Ä¶)" style="flex:1;min-width:240px" />
        <select id="filterNeed" class="hidden">
          <option value="all">Tout</option>
          <option value="needsAction">√Ä traiter</option>
          <option value="hal">HAL demand√©</option>
          <option value="comms">Com demand√©e</option>
        </select>
        <select id="filterType" class="hidden">
          <option value="all">Tous types</option>
          <option value="book">Livres</option>
          <option value="bookSection">Chapitres</option>
          <option value="journalArticle">Articles</option>
        </select>
      </div>
      <div class="msg" id="msg">üîí Non connect√©.</div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width:80px">Ann√©e</th>
            <th style="width:90px">Type</th>
            <th>Titre</th>
            <th style="width:230px">Auteur(s)</th>
            <th style="width:170px">HAL</th>
            <th style="width:200px">Communication</th>
            <th style="width:210px">Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="7" class="mini">Connecte-toi via Netlify Identity.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    let ALL = [];

    const $ = (id) => document.getElementById(id);

    function norm(s){
      return (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }
    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }
    function typeLabel(t){
      if (t === 'book') return 'Livre';
      if (t === 'bookSection') return 'Chapitre';
      if (t === 'journalArticle') return 'Article';
      return (t || '');
    }
    function yearFromDate(dateStr){
      const m = String(dateStr || '').match(/\b(19|20)\d{2}\b/);
      return m ? m[0] : '';
    }
    function statusFor(flags){
      const halWanted = flags?.hal_create === 'yes';
      const commWanted = flags?.comms_publish === 'yes';
      const halDone = flags?.hal_done === 'yes';
      const commDone = flags?.comms_done === 'yes';
      if (!halWanted && !commWanted) return {txt:'Non demand√©', cls:''};
      const needHal = halWanted && !halDone;
      const needCom = commWanted && !commDone;
      if (needHal || needCom) return {txt:'√Ä traiter', cls:'warn'};
      return {txt:'Trait√©', cls:'ok'};
    }
    function setMsg(t){ $('msg').textContent = t || ''; }

    function showAuthedUI(isAuthed){
      ['logout','refresh','q','filterNeed','filterType'].forEach(id => $(id).classList.toggle('hidden', !isAuthed));
      $('login').classList.toggle('hidden', isAuthed);
    }

    async function authedFetch(url, options = {}){
      const user = netlifyIdentity.currentUser();
      if (!user) throw new Error('Not authenticated');

      const token = await user.jwt(); // JWT GoTrue
      const headers = Object.assign({}, options.headers || {}, {
        'Authorization': 'Bearer ' + token
      });

      return fetch(url, { ...options, headers, cache: 'no-store' });
    }

    async function load(){
      setMsg('‚è≥ Chargement‚Ä¶');
      $('rows').innerHTML = `<tr><td colspan="7" class="mini">Chargement‚Ä¶</td></tr>`;

      const r = await authedFetch('/.netlify/functions/admin-items');
      const data = await r.json().catch(()=>({}));

      if (!r.ok){
        setMsg('‚ùå Erreur: ' + (data?.error || 'acc√®s refus√©'));
        $('rows').innerHTML = `<tr><td colspan="7" class="mini">Erreur serveur.</td></tr>`;
        return;
      }

      ALL = (data.items || []).map(it => ({
        ...it,
        year: it.year || yearFromDate(it.date),
      }));

      setMsg(`‚úÖ ${ALL.length} item(s) charg√©s. (sync: ${new Date(data.fetchedAt).toLocaleString('fr-FR')})`);
      render();
    }

    function render(){
      const q = norm($('q').value);
      const fNeed = $('filterNeed').value;
      const fType = $('filterType').value;

      const rows = ALL.filter(it => {
        if (fType !== 'all' && it.itemType !== fType) return false;

        const flags = it.flags || {};
        const st = statusFor(flags);

        if (fNeed === 'needsAction' && st.txt !== '√Ä traiter') return false;
        if (fNeed === 'hal' && flags.hal_create !== 'yes') return false;
        if (fNeed === 'comms' && flags.comms_publish !== 'yes') return false;

        if (!q) return true;

        const hay = norm([
          it.title,
          it.bookTitle,
          it.publicationTitle, // ‚úÖ revue
          it.publisher,
          it.place,
          it.isbn,
          it.doi,              // ‚úÖ doi
          it.volume,
          it.issue,
          it.pages,
          it.creatorsText
        ].filter(Boolean).join(' | '));

        return hay.includes(q);
      });

      rows.sort((a,b) => {
        const ay = parseInt(a.year || '0',10);
        const by = parseInt(b.year || '0',10);
        if (by !== ay) return by - ay;
        return (b.date || '').localeCompare(a.date || '');
      });

      const tbody = $('rows');
      tbody.innerHTML = '';

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="7" class="mini">Aucun r√©sultat.</td></tr>`;
        return;
      }

      for (const it of rows){
        const flags = it.flags || {};
        const st = statusFor(flags);

        const halWanted = flags.hal_create === 'yes';
        const commWanted = flags.comms_publish === 'yes';
        const halDone = flags.hal_done === 'yes';
        const commDone = flags.comms_done === 'yes';

        // ‚úÖ bloc info selon type
        let infoTop = '';
        let infoBottom = '';

        if (it.itemType === 'bookSection' && it.bookTitle) {
          infoTop = `<div class="mini">Dans : ${escapeHtml(it.bookTitle)}</div>`;
        } else if (it.itemType === 'journalArticle' && it.publicationTitle) {
          infoTop = `<div class="mini">Revue : ${escapeHtml(it.publicationTitle)}</div>`;
        }

        if (it.itemType === 'journalArticle') {
          const parts = [];
          if (it.volume) parts.push('vol. ' + escapeHtml(it.volume));
          if (it.issue) parts.push('n¬∞ ' + escapeHtml(it.issue));
          if (it.pages) parts.push('pp. ' + escapeHtml(it.pages));
          if (it.doi) parts.push('DOI ' + escapeHtml(it.doi));
          infoBottom = parts.length ? `<div class="mini">${parts.join(' ‚Äî ')}</div>` : '';
        } else {
          // Livre / Chapitre : on garde l‚Äôexistant (√©diteur/lieu/isbn)
          const parts = [];
          if (it.publisher) parts.push(escapeHtml(it.publisher));
          if (it.place) parts.push(escapeHtml(it.place));
          if (it.isbn) parts.push('ISBN ' + escapeHtml(it.isbn));
          infoBottom = parts.length ? `<div class="mini">${parts.join(' ‚Äî ')}</div>` : '';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="right">${escapeHtml(it.year || '')}</td>
          <td><span class="tag">${escapeHtml(typeLabel(it.itemType))}</span></td>
          <td>
            <div class="title">${escapeHtml(it.title || '(sans titre)')}</div>
            ${infoTop}
            ${infoBottom}
          </td>
          <td>${escapeHtml(it.creatorsText || '')}</td>

          <td>
            <div class="tag ${halWanted ? 'warn' : ''}">${halWanted ? (halDone ? 'Demand√© (trait√©)' : 'Demand√©') : 'Non'}</div>
            ${halWanted ? `<div class="chk mini" style="margin-top:8px">
              <input type="checkbox" data-k="${it.key}" data-field="hal_done" ${halDone ? 'checked' : ''}/>
              <span>HAL trait√©</span>
            </div>` : `<div class="mini muted">‚Äî</div>`}
          </td>

          <td>
            <div class="tag ${commWanted ? 'warn' : ''}">${commWanted ? (commDone ? 'Demand√© (trait√©)' : 'Demand√©') : 'Non'}</div>
            ${commWanted ? `<div class="chk mini" style="margin-top:8px">
              <input type="checkbox" data-k="${it.key}" data-field="comms_done" ${commDone ? 'checked' : ''}/>
              <span>Com trait√©e</span>
            </div>` : `<div class="mini muted">‚Äî</div>`}
          </td>

          <td>
            <div class="actions">
              <button class="primary" data-save="${it.key}">Enregistrer</button>
              <span class="tag ${st.cls}">${escapeHtml(st.txt)}</span>
            </div>
            <div class="mini muted">Key: ${escapeHtml(it.key)}</div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      tbody.querySelectorAll('button[data-save]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const key = btn.getAttribute('data-save');
          await saveRow(key, btn);
        });
      });
    }

    async function saveRow(key, btn){
      const checks = [...document.querySelectorAll(`input[type="checkbox"][data-k="${key}"]`)];
      const payload = { key };
      for (const c of checks){
        const field = c.getAttribute('data-field');
        payload[field] = c.checked ? 'yes' : 'no';
      }

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Enregistrement‚Ä¶';
      setMsg('‚è≥ Mise √† jour Zotero‚Ä¶');

      try{
        const r = await authedFetch('/.netlify/functions/admin-update-status', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=>({}));

        if (!r.ok){
          setMsg('‚ùå Erreur: ' + (data?.error || 'mise √† jour impossible'));
        } else {
          setMsg('‚úÖ Mis √† jour.');
          await load();
        }
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    // Identity wiring
    $('login').addEventListener('click', () => netlifyIdentity.open());
    $('logout').addEventListener('click', () => netlifyIdentity.logout());
    $('refresh').addEventListener('click', load);
    ['q','filterNeed','filterType'].forEach(id => $(id).addEventListener('input', render));

    netlifyIdentity.on('init', user => {
      showAuthedUI(!!user);
      setMsg(user ? '‚úÖ Connect√©. Clique ‚ÄúRafra√Æchir‚Äù.' : 'üîí Non connect√©.');
    });

    netlifyIdentity.on('login', user => {
      showAuthedUI(true);
      netlifyIdentity.close();
      setMsg('‚úÖ Connect√©. Chargement‚Ä¶');
      load();
    });

    netlifyIdentity.on('logout', () => {
      showAuthedUI(false);
      ALL = [];
      $('rows').innerHTML = `<tr><td colspan="7" class="mini">D√©connect√©.</td></tr>`;
      setMsg('üîí D√©connect√©.');
    });

    netlifyIdentity.init();
  </script>
</body>
</html>
