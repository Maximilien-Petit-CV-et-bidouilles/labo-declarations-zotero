<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Back-office ‚Äî Suivi HAL / Communication</title>

  <style>
    :root{
      --bg:#f5f5f8;--card:#fff;--text:#222;--muted:#666;--border:#ddd;
      --accent:#2c7be5;--ok:#1b7c3a;--warn:#b26a00;--bad:#b32020;
      --chip:#f2f6ff;--chip-border:#cfe0ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1150px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:1.35rem}
    .sub{margin:6px 0 0;color:var(--muted);font-size:.92rem}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    input,button,select{
      font:inherit;padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:#fff
    }
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:650}
    button.danger{background:#fff;border-color:rgba(179,32,32,.5);color:var(--bad);font-weight:650}

    .msg{margin-top:10px;color:var(--muted);font-size:.9rem;white-space:pre-wrap}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.82rem;color:var(--muted);text-align:left;white-space:nowrap}
    td{font-size:.92rem}

    .title{font-weight:650}
    .mini{font-size:.82rem;color:var(--muted);margin-top:4px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:.82rem;background:#fff;white-space:nowrap}
    .tag.ok{border-color:rgba(27,124,58,.35);background:rgba(27,124,58,.08);color:var(--ok)}
    .tag.warn{border-color:rgba(178,106,0,.35);background:rgba(178,106,0,.08);color:var(--warn)}

    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chk{display:flex;gap:8px;align-items:center}
    .chk input{width:18px;height:18px;padding:0}
    .right{white-space:nowrap}
    .hidden{display:none}

    /* Axes chips */
    .axes{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{
      display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;
      border:1px solid var(--chip-border);background:var(--chip);
      font-size:.78rem;font-weight:650;color:#1d3c76;
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div>
      <h1>Back-office ‚Äî Suivi HAL & Communication</h1>
      <p class="sub">Modification des statuts directement dans Zotero (champ Extra).</p>
    </div>
    <div class="row">
      <button id="login" class="primary">Se connecter</button>
      <button id="logout" class="danger hidden">Se d√©connecter</button>
      <button id="refresh" class="primary hidden">Rafra√Æchir</button>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <input id="q" class="hidden" type="search" placeholder="Recherche (titre, auteur, revue, axes‚Ä¶)" style="flex:1;min-width:240px">

      <select id="filterNeed" class="hidden">
        <option value="all">Toutes demandes</option>
        <option value="needsAction">√Ä traiter</option>
        <option value="hal">HAL demand√©e</option>
        <option value="comms">Com demand√©e</option>
      </select>

      <select id="filterType" class="hidden">
        <option value="all">Tous types</option>
        <option value="book">Livre</option>
        <option value="bookSection">Chapitre</option>
        <option value="journalArticle">Article</option>
      </select>

      <!-- Filtre Axe -->
      <select id="filterAxis" class="hidden">
        <option value="all">Tous axes</option>
        <option value="PICMAP">PICMAP</option>
        <option value="MOPTIS">MOPTIS</option>
        <option value="OCSO">OCSO</option>
        <option value="none">Sans axe</option>
      </select>
    </div>

    <div class="msg" id="msg">üîí Non connect√©.</div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th style="width:80px">Ann√©e</th>
          <th style="width:90px">Type</th>
          <th>Titre</th>
          <th style="width:220px">Auteur(s)</th>
          <th style="width:160px">HAL</th>
          <th style="width:190px">Communication</th>
          <th style="width:210px">Actions</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="7" class="mini">Connexion requise.</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script>
  let ALL = [];
  const $ = id => document.getElementById(id);

  function norm(s){
    return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  }

  function yearFromDate(d){
    const m = String(d||'').match(/\b(19|20)\d{2}\b/);
    return m ? m[0] : '';
  }

  function statusFor(flags){
    const halW = flags?.hal_create === 'yes';
    const comW = flags?.comms_publish === 'yes';
    const halD = flags?.hal_done === 'yes';
    const comD = flags?.comms_done === 'yes';
    if (!halW && !comW) return {txt:'Non demand√©', cls:''};
    if ((halW && !halD) || (comW && !comD)) return {txt:'√Ä traiter', cls:'warn'};
    return {txt:'Trait√©', cls:'ok'};
  }

  /* ‚úÖ parse axes robuste */
  function parseAxes(flags){
    const raw = flags?.axes ? String(flags.axes).trim() : '';
    if (!raw || raw === 'none') return [];
    return raw
      .split(/[,;|]/)
      .map(s => s.trim())
      .filter(Boolean)
      .map(s => s.toUpperCase());
  }

  function showAuthed(ok){
    ['logout','refresh','q','filterNeed','filterType','filterAxis']
      .forEach(id => $(id).classList.toggle('hidden', !ok));
    $('login').classList.toggle('hidden', ok);
  }

  async function authedFetch(url, opts={}){
    const u = netlifyIdentity.currentUser();
    if (!u) throw new Error();
    const t = await u.jwt();
    return fetch(url,{
      ...opts,
      headers:{...(opts.headers||{}),'Authorization':'Bearer '+t},
      cache:'no-store'
    });
  }

  async function load(){
    $('msg').textContent = '‚è≥ Chargement‚Ä¶';
    $('rows').innerHTML = `<tr><td colspan="7" class="mini">Chargement‚Ä¶</td></tr>`;

    const r = await authedFetch('/.netlify/functions/admin-items');
    const d = await r.json().catch(()=>({}));

    if (!r.ok){
      $('msg').textContent = '‚ùå Erreur d‚Äôacc√®s';
      return;
    }

    ALL = (d.items||[]).map(it=>({...it,year:it.year||yearFromDate(it.date)}));
    $('msg').textContent = `‚úÖ ${ALL.length} item(s) charg√©s`;
    render();
  }

  function render(){
    const q = norm($('q').value);
    const fNeed = $('filterNeed').value;
    const fType = $('filterType').value;
    const fAxis = $('filterAxis').value.toUpperCase();

    const rows = ALL.filter(it=>{
      if (fType!=='all' && it.itemType!==fType) return false;

      const flags = it.flags||{};
      const st = statusFor(flags);

      if (fNeed==='needsAction' && st.txt!=='√Ä traiter') return false;
      if (fNeed==='hal' && flags.hal_create!=='yes') return false;
      if (fNeed==='comms' && flags.comms_publish!=='yes') return false;

      const axes = parseAxes(flags);
      if (fAxis!=='ALL'){
        if (fAxis==='NONE' && axes.length) return false;
        if (fAxis!=='NONE' && !axes.includes(fAxis)) return false;
      }

      if (!q) return true;

      const hay = norm([
        it.title,it.bookTitle,it.publicationTitle,it.publisher,
        it.place,it.isbn,it.doi,it.creatorsText,(flags.axes||'')
      ].join(' '));

      return hay.includes(q);
    });

    const tb = $('rows');
    tb.innerHTML = '';

    if (!rows.length){
      tb.innerHTML = `<tr><td colspan="7" class="mini">Aucun r√©sultat.</td></tr>`;
      return;
    }

    rows.sort((a,b)=>(b.year||0)-(a.year||0));

    for (const it of rows){
      const flags = it.flags||{};
      const st = statusFor(flags);
      const axes = parseAxes(flags);
      const axesHtml = axes.length
        ? `<div class="axes">${axes.map(a=>`<span class="chip">${a}</span>`).join('')}</div>`
        : '';

      tb.insertAdjacentHTML('beforeend',`
        <tr>
          <td class="right">${it.year||''}</td>
          <td><span class="tag">${it.itemType}</span></td>
          <td>
            <div class="title">${it.title||'(sans titre)'}</div>
            ${axesHtml}
          </td>
          <td>${it.creatorsText||''}</td>
          <td><span class="tag">${flags.hal_create==='yes'?'Demand√©':'Non'}</span></td>
          <td><span class="tag">${flags.comms_publish==='yes'?'Demand√©':'Non'}</span></td>
          <td><span class="tag ${st.cls}">${st.txt}</span></td>
        </tr>
      `);
    }
  }

  /* listeners robustes */
  $('q').addEventListener('input', render);
  ['filterNeed','filterType','filterAxis'].forEach(id =>
    $(id).addEventListener('change', render)
  );

  $('login').onclick = () => netlifyIdentity.open();
  $('logout').onclick = () => netlifyIdentity.logout();
  $('refresh').onclick = load;

  netlifyIdentity.on('init', u=>{
    showAuthed(!!u);
    $('msg').textContent = u ? 'Connect√©.' : 'üîí Non connect√©.';
  });
  netlifyIdentity.on('login', u=>{
    showAuthed(true);
    netlifyIdentity.close();
    load();
  });
  netlifyIdentity.on('logout', ()=>{
    showAuthed(false);
    ALL=[];
    $('rows').innerHTML='<tr><td colspan="7" class="mini">D√©connect√©.</td></tr>';
  });
  netlifyIdentity.init();
</script>
</body>
</html>
