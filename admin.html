<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Back-office ‚Äî Suivi HAL / Communication</title>
  <style>
    :root{
      --bg:#f5f5f8;--card:#fff;--text:#222;--muted:#666;--border:#ddd;
      --accent:#2c7be5;--ok:#1b7c3a;--warn:#b26a00;--bad:#b32020;
      --chip:#f2f6ff;--chip-border:#cfe0ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:1.45rem}
    .sub{margin:6px 0 0;color:var(--muted);font-size:.92rem}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:.85rem;color:var(--muted)}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}

    .top-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .who{font-size:.85rem;color:var(--muted)}

    .controls{display:grid;grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr;gap:10px}
    @media (max-width: 1100px){ .controls{grid-template-columns:1fr 1fr 1fr} }
    @media (max-width: 800px){ .controls{grid-template-columns:1fr 1fr 1fr} }
    @media (max-width: 520px){ .controls{grid-template-columns:1fr} }

    input,select,button{
      font:inherit;padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:#fff
    }
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:650}
    button.ghost{background:#fff}
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .stat{min-width:160px}
    .stat b{display:block;font-size:1.05rem}
    .stat span{color:var(--muted);font-size:.85rem}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.82rem;color:var(--muted);text-align:left;white-space:nowrap}
    td{font-size:.92rem}
    .title{font-weight:650}
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;border:1px solid var(--border);
      font-size:.82rem;background:#fff;white-space:nowrap
    }
    .tag.ok{border-color:rgba(27,124,58,.35);background:rgba(27,124,58,.08);color:var(--ok)}
    .tag.warn{border-color:rgba(178,106,0,.35);background:rgba(178,106,0,.08);color:var(--warn)}
    .tag.bad{border-color:rgba(179,32,32,.35);background:rgba(179,32,32,.08);color:var(--bad)}
    .mini{font-size:.82rem}
    .right{white-space:nowrap}

    .axes{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{
      display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;
      border:1px solid var(--chip-border);background:var(--chip);
      font-size:.78rem;font-weight:650;color:#1d3c76;white-space:nowrap;
    }

    .statusline{margin-top:10px;color:var(--muted);font-size:.9rem;white-space:pre-wrap}
    .loading{display:inline-flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent);display:inline-block;animation:pulse 1s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%,100%{opacity:.25}50%{opacity:1}}

    .clamp{
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .pager{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px}
    .pagerSide{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Back-office ‚Äî HAL & Communication</h1>
        <p class="sub">Connexion requise (Netlify Identity). √âditez les demandes (HAL / Com) et leur statut.</p>
      </div>
      <div class="top-actions">
        <span class="who" id="who">Non connect√©</span>
        <button class="ghost" id="loginBtn">Se connecter</button>
        <button class="ghost" id="logoutBtn" style="display:none">Se d√©connecter</button>
        <div class="pill" id="lastUpdate">‚Äî</div>
      </div>
    </header>

    <div class="bar">
      <div class="card" style="flex:1;min-width:260px">
        <div class="controls">
          <input id="q" type="search" placeholder="Rechercher (titre, auteur, revue, conf√©rence, axes, √©diteur, ISBN, DOI‚Ä¶)" />
          <select id="filterType">
            <option value="all">Tous types</option>
            <option value="book">Livres</option>
            <option value="bookSection">Chapitres</option>
            <option value="journalArticle">Articles</option>
            <option value="conferencePaper">Communications</option>
          </select>
          <select id="filterNeeds">
            <option value="all">Toutes demandes</option>
            <option value="needsAction">√Ä traiter</option>
            <option value="halYes">HAL demand√©</option>
            <option value="commsYes">Com demand√©</option>
          </select>

          <select id="filterAxis">
            <option value="all">Tous axes</option>
            <option value="PICMAP">PICMAP</option>
            <option value="MOPTIS">MOPTIS</option>
            <option value="OCSO">OCSO</option>
            <option value="none">Sans axe</option>
          </select>

          <select id="filterYear">
            <option value="all">Toutes ann√©es</option>
          </select>

          <button class="ghost" id="reset">R√©initialiser</button>
          <button class="primary" id="refresh">Rafra√Æchir</button>
        </div>

        <div class="statusline" id="msg"></div>

        <div class="stats" style="margin-top:12px">
          <div class="stat"><b id="sTotal">‚Äî</b><span>items</span></div>
          <div class="stat"><b id="sNeed">‚Äî</b><span>√† traiter</span></div>
          <div class="stat"><b id="sHal">‚Äî</b><span>HAL demand√©s</span></div>
          <div class="stat"><b id="sComms">‚Äî</b><span>Communications demand√©es</span></div>
        </div>

        <div class="pager">
          <div class="pagerSide">
            <button class="ghost" id="prev">‚Üê</button>
            <button class="ghost" id="next">‚Üí</button>
            <span class="muted" id="pageInfo">‚Äî</span>
          </div>
          <div class="pagerSide">
            <span class="muted">Par page</span>
            <select id="pageSize">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>
        </div>

      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width:90px">Ann√©e</th>
            <th style="width:90px">Type</th>
            <th>Titre</th>
            <th style="width:220px">Auteur(s)</th>
            <th style="width:180px">HAL</th>
            <th style="width:210px">Communication</th>
            <th style="width:140px">Statut</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="7">
            <span class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Chargement des donn√©es‚Ä¶</span>
          </td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    let ALL = [];
    let VIEW = [];
    let PAGE = 1;
    let PAGE_SIZE = 50;

    const $ = (id) => document.getElementById(id);

    function setMsg(s){ $('msg').textContent = s || ''; }
    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function norm(s){
      return (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }
    function typeLabel(t){
      if (t === 'book') return 'Livre';
      if (t === 'bookSection') return 'Chapitre';
      if (t === 'journalArticle') return 'Article';
      if (t === 'conferencePaper') return 'Communication';
      return t || '';
    }
    function yearFromDate(dateStr){
      const m = (dateStr || '').match(/\b(19|20)\d{2}\b/);
      return m ? m[0] : '';
    }
    function joinCreators(creators){
      if (!Array.isArray(creators)) return '';
      const names = creators
        .filter(c => c && (c.creatorType === 'author' || c.creatorType === 'editor' || c.creatorType === 'presenter'))
        .map(c => {
          const fn = (c.firstName || '').trim();
          const ln = (c.lastName || '').trim();
          return (ln && fn) ? (ln + ' ' + fn) : (ln || fn);
        })
        .filter(Boolean);
      return names.join(', ');
    }
    function tagYesNo(val){
      if (val === 'yes') return { txt:'Oui', cls:'ok' };
      if (val === 'no') return { txt:'Non', cls:'' };
      return { txt:'‚Äî', cls:'' };
    }
    function statusFor(item){
      const f = item.flags || {};
      const halWanted = f.hal_create === 'yes';
      const commWanted = f.comms_publish === 'yes';
      const halDone = f.hal_done === 'yes';
      const commDone = f.comms_done === 'yes';

      if (!halWanted && !commWanted) return { txt:'Non demand√©', cls:'' };

      const needHal = halWanted && !halDone;
      const needCom = commWanted && !commDone;

      if (needHal || needCom) return { txt:'√Ä traiter', cls:'warn' };
      return { txt:'Trait√©', cls:'ok' };
    }
    function parseAxes(flags){
      const raw = (flags && flags.axes) ? String(flags.axes).trim() : '';
      if (!raw || raw === 'none') return [];
      return raw.split(/[,;|]/).map(s => s.trim()).filter(Boolean).map(s => s.toUpperCase());
    }

    function fillYears(items){
      const years = [...new Set(items.map(i => i.year).filter(Boolean))].sort((a,b)=>b.localeCompare(a));
      const sel = $('filterYear');
      const cur = sel.value;
      sel.innerHTML = `<option value="all">Toutes ann√©es</option>` + years.map(y => `<option value="${y}">${y}</option>`).join('');
      sel.value = years.includes(cur) ? cur : 'all';
    }

    function showAuthUI(user){
      if (!user){
        $('who').textContent = 'Non connect√©';
        $('loginBtn').style.display = '';
        $('logoutBtn').style.display = 'none';
        return;
      }
      const email = user.email || user.user_metadata?.email || '';
      $('who').textContent = email ? ('Connect√© : ' + email) : 'Connect√©';
      $('loginBtn').style.display = 'none';
      $('logoutBtn').style.display = '';
    }

    function openLogin(){ window.netlifyIdentity && window.netlifyIdentity.open(); }
    function doLogout(){ window.netlifyIdentity && window.netlifyIdentity.logout(); }

    async function authedFetch(url, opts={}){
      const user = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      if (!user) return new Response(JSON.stringify({ error:'Unauthorized (not logged in)' }), { status:401 });
      const token = await user.jwt();
      const headers = new Headers(opts.headers || {});
      headers.set('Authorization', 'Bearer ' + token);
      return fetch(url, { ...opts, headers, cache:'no-store' });
    }

    function renderPager(){
      const total = VIEW.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const from = total ? ((PAGE - 1) * PAGE_SIZE + 1) : 0;
      const to = Math.min(total, PAGE * PAGE_SIZE);
      $('pageInfo').textContent = `${from}-${to} / ${total}`;
      $('prev').disabled = PAGE <= 1;
      $('next').disabled = PAGE >= totalPages;
    }

    function setPage(n){
      const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
      PAGE = Math.min(Math.max(1, n), totalPages);
      renderTable();
      renderPager();
    }

    function applyFilters(){
      const q = norm($('q').value);
      const fType = $('filterType').value;
      const fNeeds = $('filterNeeds').value;
      const fAxis = $('filterAxis').value;
      const fYear = $('filterYear').value;

      VIEW = ALL.filter(it => {
        if (fType !== 'all' && it.itemType !== fType) return false;

        const y = it.year || '';
        if (fYear !== 'all' && y !== fYear) return false;

        const flags = it.flags || {};
        const st = statusFor(it);

        if (fNeeds === 'needsAction' && st.txt !== '√Ä traiter') return false;
        if (fNeeds === 'halYes' && flags.hal_create !== 'yes') return false;
        if (fNeeds === 'commsYes' && flags.comms_publish !== 'yes') return false;

        const axes = parseAxes(flags);
        const axisSel = String(fAxis || 'all').toUpperCase();
        if (axisSel !== 'ALL') {
          if (axisSel === 'NONE' && axes.length) return false;
          if (axisSel !== 'NONE' && !axes.includes(axisSel)) return false;
        }

        if (!q) return true;

        const axesStr = (flags.axes && flags.axes !== 'none') ? String(flags.axes) : '';
        const hay = norm([
          it.title,
          it.bookTitle,
          it.publicationTitle,
          it.conferenceName,
          it.publisher,
          it.place,
          it.isbn,
          it.doi,
          it.volume,
          it.issue,
          it.pages,
          axesStr,
          it.creatorsText
        ].filter(Boolean).join(' | '));

        return hay.includes(q);
      });

      $('sTotal').textContent = VIEW.length;
      $('sNeed').textContent = VIEW.filter(it => statusFor(it).txt === '√Ä traiter').length;
      $('sHal').textContent = VIEW.filter(it => it.flags?.hal_create === 'yes').length;
      $('sComms').textContent = VIEW.filter(it => it.flags?.comms_publish === 'yes').length;

      VIEW.sort((a,b) => {
        const ay = parseInt(a.year || '0',10);
        const by = parseInt(b.year || '0',10);
        if (by !== ay) return by - ay;
        return (b.date || '').localeCompare(a.date || '');
      });

      setPage(1);
    }

    async function updateFlags(key, patch){
      const r = await authedFetch('/.netlify/functions/admin-update-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key, patch })
      });
      const data = await r.json().catch(()=>({}));
      if (!r.ok) throw new Error(data?.error || `Erreur (${r.status})`);
      return data;
    }

    function renderTable(){
      const tbody = $('rows');
      tbody.innerHTML = '';

      if (!VIEW.length){
        tbody.innerHTML = `<tr><td colspan="7" class="mini muted">Aucun r√©sultat.</td></tr>`;
        return;
      }

      const start = (PAGE - 1) * PAGE_SIZE;
      const slice = VIEW.slice(start, start + PAGE_SIZE);

      for (const it of slice){
        const flags = it.flags || {};
        const st = statusFor(it);

        const halWanted = flags.hal_create === 'yes';
        const commWanted = flags.comms_publish === 'yes';
        const halDone = flags.hal_done === 'yes';
        const commDone = flags.comms_done === 'yes';

        let infoTop = '';
        let infoBottom = '';

        if (it.itemType === 'bookSection' && it.bookTitle) {
          infoTop = `<div class="mini">Dans : ${escapeHtml(it.bookTitle)}</div>`;
        } else if (it.itemType === 'journalArticle' && it.publicationTitle) {
          infoTop = `<div class="mini">Revue : ${escapeHtml(it.publicationTitle)}</div>`;
        } else if (it.itemType === 'conferencePaper' && it.conferenceName) {
          infoTop = `<div class="mini">Conf√©rence : ${escapeHtml(it.conferenceName)}</div>`;
        }

        const axes = parseAxes(flags);
        const axesHtml = axes.length
          ? `<div class="axes">` + axes.map(a => `<span class="chip">${escapeHtml(a)}</span>`).join('') + `</div>`
          : '';

        const authorsFull = it.creatorsText || '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="right">${escapeHtml(it.year || '')}</td>
          <td><span class="tag">${escapeHtml(typeLabel(it.itemType))}</span></td>
          <td>
            <div class="title">${escapeHtml(it.title || '(sans titre)')}</div>
            ${infoTop}
            ${infoBottom}
            ${axesHtml}
          </td>
          <td><div class="clamp" title="${escapeHtml(authorsFull)}">${escapeHtml(authorsFull)}</div></td>

          <td>
            <div class="tag ${halWanted ? 'warn' : ''}">
              ${halWanted ? (halDone ? 'Demand√© (trait√©)' : 'Demand√©') : 'Non'}
            </div>
            ${halWanted ? `
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="ghost" data-act="hal_done" data-key="${escapeHtml(it.key)}" data-val="${halDone ? 'no' : 'yes'}">
                  ${halDone ? 'Marquer ‚Äú√† faire‚Äù' : 'Marquer ‚Äúfait‚Äù'}
                </button>
              </div>
            ` : ''}
          </td>

          <td>
            <div class="tag ${commWanted ? 'warn' : ''}">
              ${commWanted ? (commDone ? 'Demand√© (trait√©)' : 'Demand√©') : 'Non'}
            </div>
            ${commWanted ? `
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="ghost" data-act="comms_done" data-key="${escapeHtml(it.key)}" data-val="${commDone ? 'no' : 'yes'}">
                  ${commDone ? 'Marquer ‚Äú√† faire‚Äù' : 'Marquer ‚Äúfait‚Äù'}
                </button>
              </div>
            ` : ''}
          </td>

          <td><span class="tag ${st.cls}">${escapeHtml(st.txt)}</span></td>
        `;

        tr.querySelectorAll('button[data-act]').forEach(btn => {
          btn.addEventListener('click', async (ev) => {
            ev.preventDefault();
            const act = btn.getAttribute('data-act');
            const key = btn.getAttribute('data-key');
            const val = btn.getAttribute('data-val');

            btn.disabled = true;
            const old = btn.textContent;
            btn.textContent = '‚Ä¶';

            try{
              await updateFlags(key, { [act]: val });
              const target = ALL.find(x => x.key === key);
              if (target){
                target.flags = target.flags || {};
                target.flags[act] = val;
              }
              applyFilters();
              setMsg('‚úÖ Mise √† jour enregistr√©e.');
              setTimeout(()=>setMsg(''), 1200);
            }catch(e){
              console.error(e);
              setMsg('‚ùå ' + (e?.message || e));
              btn.disabled = false;
              btn.textContent = old;
            }
          });
        });

        tbody.appendChild(tr);
      }
    }

    async function load(){
      setMsg('‚è≥ Chargement‚Ä¶');
      $('rows').innerHTML = `<tr><td colspan="7" class="mini">Chargement‚Ä¶</td></tr>`;

      const first = await authedFetch('/.netlify/functions/admin-items?start=0&limit=100');
      const data1 = await first.json().catch(()=>({}));

      if (!first.ok){
        setMsg('‚ùå ' + (data1?.error || 'acc√®s refus√©'));
        $('rows').innerHTML = `<tr><td colspan="7" class="mini">Erreur serveur.</td></tr>`;
        return;
      }

      const items = Array.isArray(data1.items) ? data1.items : [];
      ALL = items.map(it => {
        const y = it.year || yearFromDate(it.date);
        return { ...it, year: y || '', creatorsText: it.creatorsText || joinCreators(it.creators || []) };
      });

      let start = items.length;
      let hasMore = !!data1.hasMore;

      while (hasMore){
        const r = await authedFetch(`/.netlify/functions/admin-items?start=${start}&limit=200`);
        const d = await r.json().catch(()=>({}));
        if (!r.ok) break;
        const page = Array.isArray(d.items) ? d.items : [];
        if (!page.length) break;
        ALL.push(...page.map(it => {
          const y = it.year || yearFromDate(it.date);
          return { ...it, year: y || '', creatorsText: it.creatorsText || joinCreators(it.creators || []) };
        }));
        start += page.length;
        hasMore = !!d.hasMore;
      }

      fillYears(ALL);

      const ts = data1.fetchedAt ? new Date(data1.fetchedAt) : new Date();
      $('lastUpdate').textContent = `Derni√®re mise √† jour : ${ts.toLocaleString('fr-FR')}`;

      setMsg('');
      applyFilters();
    }

    // UI events
    $('loginBtn').addEventListener('click', () => openLogin());
    $('logoutBtn').addEventListener('click', () => doLogout());

    $('q').addEventListener('input', applyFilters);
    ['filterType','filterNeeds','filterAxis','filterYear'].forEach(id => $(id).addEventListener('change', applyFilters));
    $('reset').addEventListener('click', () => {
      $('q').value=''; $('filterType').value='all'; $('filterNeeds').value='all'; $('filterAxis').value='all'; $('filterYear').value='all';
      applyFilters();
    });
    $('refresh').addEventListener('click', load);

    $('prev').addEventListener('click', () => setPage(PAGE - 1));
    $('next').addEventListener('click', () => setPage(PAGE + 1));
    $('pageSize').addEventListener('change', () => {
      const v = parseInt($('pageSize').value,10);
      if (Number.isFinite(v) && v>0 && v<=500){ PAGE_SIZE=v; setPage(1); }
    });

    // Identity init
    if (window.netlifyIdentity){
      window.netlifyIdentity.on('init', user => {
        showAuthUI(user);
        if (user) load();
        else setMsg('üîí Cliquez sur ‚ÄúSe connecter‚Äù.');
      });
      window.netlifyIdentity.on('login', user => {
        showAuthUI(user);
        window.netlifyIdentity.close();
        load();
      });
      window.netlifyIdentity.on('logout', () => {
        showAuthUI(null);
        setMsg('üîí D√©connect√©.');
        $('rows').innerHTML = `<tr><td colspan="7" class="mini">D√©connect√©.</td></tr>`;
      });
      window.netlifyIdentity.init();
    } else {
      setMsg('‚ö†Ô∏è Netlify Identity non disponible.');
    }
  </script>
</body>
</html>
