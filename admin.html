<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Suivi HAL / Communication</title>
  <style>
    :root{
      --bg:#f5f5f8;--card:#fff;--text:#222;--muted:#666;--border:#ddd;
      --accent:#2c7be5;--ok:#1b7c3a;--warn:#b26a00;--bad:#b32020;
      --chip:#f2f6ff;--chip-border:#cfe0ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1250px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:1.45rem}
    .sub{margin:6px 0 0;color:var(--muted);font-size:.92rem}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:.85rem;color:var(--muted)}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}

    .controls{display:grid;grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr;gap:10px}
    @media (max-width: 1100px){ .controls{grid-template-columns:1fr 1fr 1fr} }
    @media (max-width: 800px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width: 520px){ .controls{grid-template-columns:1fr} }

    input,select,button{
      font:inherit;padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:#fff
    }
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:650}
    button.ghost{background:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}

    .top-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .who{font-size:.85rem;color:var(--muted)}

    .stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .stat{min-width:160px}
    .stat b{display:block;font-size:1.05rem}
    .stat span{color:var(--muted);font-size:.85rem}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.82rem;color:var(--muted);text-align:left;white-space:nowrap}
    td{font-size:.92rem}
    .title a{color:inherit;text-decoration:none}
    .title a:hover{text-decoration:underline}
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;border:1px solid var(--border);
      font-size:.82rem;background:#fff;white-space:nowrap
    }
    .tag.ok{border-color:rgba(27,124,58,.35);background:rgba(27,124,58,.08);color:var(--ok)}
    .tag.warn{border-color:rgba(178,106,0,.35);background:rgba(178,106,0,.08);color:var(--warn)}
    .tag.bad{border-color:rgba(179,32,32,.35);background:rgba(179,32,32,.08);color:var(--bad)}
    .mini{font-size:.82rem;color:var(--muted)}
    .right{white-space:nowrap}

    /* Axes chips */
    .axes{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{
      display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;
      border:1px solid var(--chip-border);background:var(--chip);
      font-size:.78rem;font-weight:650;color:#1d3c76;white-space:nowrap;
    }

    /* Auteurs: clamp + tooltip */
    td.auth{max-width:260px;word-break:break-word}
    .authClamp{display:block;overflow:hidden;text-overflow:ellipsis}

    .statusline{margin-top:10px;color:var(--muted);font-size:.9rem;white-space:pre-wrap}
    .loading{display:inline-flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent);display:inline-block;animation:pulse 1s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%,100%{opacity:.25}50%{opacity:1}}

    /* Pagination */
    .pager_allowwrap {display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px}
    .pager_side {display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Login box */
    .loginBox{
      margin-top:14px;
      padding:14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Admin — Suivi HAL & Communication</h1>
        <p class="sub">Accès réservé (Netlify Identity) — gestion interne du traitement.</p>
      </div>
      <div class="top-actions">
        <span class="who" id="who">Non connecté</span>
        <button class="ghost" id="loginBtn">Se connecter</button>
        <button class="ghost" id="logoutBtn" style="display:none">Se déconnecter</button>
        <div class="pill" id="lastUpdate">—</div>
      </div>
    </header>

    <div class="card loginBox" id="loginBox" style="display:none">
      <div style="font-weight:700;margin-bottom:6px">Connexion requise</div>
      <div class="muted" style="margin-bottom:10px">
        Cliquez sur “Se connecter” (en haut à droite) pour accéder à la liste.
      </div>
      <button class="primary" id="loginBtn2">Se connecter</button>
      <div class="statusline" id="loginMsg"></div>
    </div>

    <div class="bar" id="adminUI" style="display:none">
      <div class="card" style="flex:1;min-width:260px">
        <div class="controls">
          <input id="q" type="search" placeholder="Rechercher (titre, auteur, revue, conférence, axes, éditeur, ISBN, DOI…)" />
          <select id="filterType">
            <option value="all">Tous types</option>
            <option value="book">Livres</option>
            <option value="bookSection">Chapitres</option>
            <option value="journalArticle">Articles</option>
            <option value="conferencePaper">Communications</option>
          </select>
          <select id="filterNeeds">
            <option value="all">Toutes demandes</option>
            <option value="needsAction">À traiter</option>
            <option value="halYes">HAL demandé</option>
            <option value="commsYes">Com demandé</option>
          </select>

          <select id="filterAxis">
            <option value="all">Tous axes</option>
            <option value="PICMAP">PICMAP</option>
            <option value="MOPTIS">MOPTIS</option>
            <option value="OCSO">OCSO</option>
            <option value="none">Sans axe</option>
          </select>

          <select id="filterYear">
            <option value="all">Toutes années</option>
          </select>

          <button class="ghost" id="reset">Réinitialiser</button>
          <button class="primary" id="refresh">Rafraîchir</button>
        </div>

        <div class="statusline" id="msg"></div>

        <div class="stats">
          <div class="stat"><b id="sTotal">—</b><span>items</span></div>
          <div class="stat"><b id="sNeed">—</b><span>à traiter</span></div>
          <div class="stat"><b id="sHal">—</b><span>HAL demandés</span></div>
          <div class="stat"><b id="sComms">—</b><span>Communications demandées</span></div>
        </div>

        <div class="pager_allowwrap">
          <div class="pager_side">
            <button class="ghost" id="prev">←</button>
            <button class="ghost" id="next">→</button>
            <span class="muted" id="pageInfo">—</span>
          </div>
          <div class="pager_side">
            <span class="muted">Par page</span>
            <select id="pageSize">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>
        </div>

      </div>
    </div>

    <div class="card" id="tableCard" style="display:none">
      <table>
        <thead>
          <tr>
            <th style="width:90px">Année</th>
            <th style="width:120px">Type</th>
            <th>Titre</th>
            <th style="width:260px">Auteur(s)</th>
            <th style="width:150px">HAL</th>
            <th style="width:180px">Communication</th>
            <th style="width:140px">Statut</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="7">
            <span class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Chargement…</span>
          </td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- Netlify Identity (indispensable pour login) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    // ------------------------------------------------------------
    // Identity helpers
    // ------------------------------------------------------------
    const $ = (id) => document.getElementById(id);

    function showLoggedOut(){
      $('who').textContent = 'Non connecté';
      $('loginBtn').style.display = '';
      $('logoutBtn').style.display = 'none';
      $('loginBox').style.display = '';
      $('adminUI').style.display = 'none';
      $('tableCard').style.display = 'none';
    }

    function showLoggedIn(user){
      const email = user?.email || user?.user_metadata?.email || '';
      $('who').textContent = email ? `Connecté : ${email}` : 'Connecté';
      $('loginBtn').style.display = 'none';
      $('logoutBtn').style.display = '';
      $('loginBox').style.display = 'none';
      $('adminUI').style.display = '';
      $('tableCard').style.display = '';
    }

    function openLogin(){
      if (!window.netlifyIdentity) return;
      window.netlifyIdentity.open();
    }

    function logout(){
      if (!window.netlifyIdentity) return;
      window.netlifyIdentity.logout();
    }

    // ------------------------------------------------------------
    // Admin table logic (pagination + clamp + conferencePaper)
    // ------------------------------------------------------------
    let ALL = [];
    let VIEW = [];
    let PAGE = 1;
    let PAGE_SIZE = 50;

    function norm(s){
      return (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }

    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function typeLabel(t){
      if (t === 'book') return 'Livre';
      if (t === 'bookSection') return 'Chapitre';
      if (t === 'journalArticle') return 'Article';
      if (t === 'conferencePaper') return 'Communication';
      return t || '';
    }

    function yearFromDate(dateStr){
      const m = (dateStr || '').match(/\b(19|20)\d{2}\b/);
      return m ? m[0] : '';
    }

    function joinCreators(creators){
      if (!Array.isArray(creators)) return '';
      const names = creators
        .filter(c => c && (c.creatorType === 'author' || c.creatorType === 'editor' || c.creatorType === 'presenter'))
        .map(c => {
          const fn = (c.firstName || '').trim();
          const ln = (c.lastName || '').trim();
          return (ln && fn) ? (ln + ' ' + fn) : (ln || fn);
        })
        .filter(Boolean);
      return names.join(', ');
    }

    function clampAuthors(full, maxNames = 6){
      const s = String(full || '').trim();
      if (!s) return { short:'', full:'' };
      const parts = s.split(/\s*,\s*/).filter(Boolean);
      if (parts.length <= maxNames) return { short:s, full:s };
      return { short: parts.slice(0,maxNames).join(', ') + `, … (+${parts.length-maxNames})`, full:s };
    }

    function tagYesNo(val){
      if (val === 'yes') return { txt:'Oui', cls:'ok' };
      if (val === 'no') return { txt:'Non', cls:'' };
      return { txt:'—', cls:'' };
    }

    function statusFor(item){
      const f = item.flags || {};
      const halWanted = f.hal_create === 'yes';
      const commWanted = f.comms_publish === 'yes';
      const halDone = f.hal_done === 'yes';
      const commDone = f.comms_done === 'yes';

      if (!halWanted && !commWanted) return { txt:'Non demandé', cls:'' };

      const needHal = halWanted && !halDone;
      const needCom = commWanted && !commDone;

      if (needHal || needCom) return { txt:'À traiter', cls:'warn' };
      return { txt:'Traité', cls:'ok' };
    }

    function parseAxes(flags){
      const raw = (flags && flags.axes) ? String(flags.axes).trim() : '';
      if (!raw || raw === 'none') return [];
      return raw
        .split(/[,;|]/)
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => s.toUpperCase());
    }

    function fillYears(items){
      const years = [...new Set(items.map(i => i.year).filter(Boolean))].sort((a,b)=>b.localeCompare(a));
      const sel = $('filterYear');
      const cur = sel.value;
      sel.innerHTML = `<option value="all">Toutes années</option>` + years.map(y => `<option value="${y}">${y}</option>`).join('');
      sel.value = years.includes(cur) ? cur : 'all';
    }

    function setPage(n){
      const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
      PAGE = Math.min(Math.max(1, n), totalPages);
      renderTable();
      renderPager();
    }

    function renderPager(){
      const total = VIEW.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const from = total ? ((PAGE - 1) * PAGE_SIZE + 1) : 0;
      const to = Math.min(total, PAGE * PAGE_SIZE);
      $('pageInfo').textContent = `${from}-${to} / ${total}`;
      $('prev').disabled = PAGE <= 1;
      $('next').disabled = PAGE >= totalPages;
    }

    function applyFilters(){
      const q = norm($('q').value);
      const fType = $('filterType').value;
      const fNeeds = $('filterNeeds').value;
      const fAxis = $('filterAxis').value;
      const fYear = $('filterYear').value;

      VIEW = ALL.filter(it => {
        if (fType !== 'all' && it.itemType !== fType) return false;

        const y = it.year || '';
        if (fYear !== 'all' && y !== fYear) return false;

        const flags = it.flags || {};
        const st = statusFor(it);

        if (fNeeds === 'needsAction' && st.txt !== 'À traiter') return false;
        if (fNeeds === 'halYes' && flags.hal_create !== 'yes') return false;
        if (fNeeds === 'commsYes' && flags.comms_publish !== 'yes') return false;

        const axes = parseAxes(flags);
        const axisSel = String(fAxis || 'all').toUpperCase();
        if (axisSel !== 'ALL') {
          if (axisSel === 'NONE' && axes.length) return false;
          if (axisSel !== 'NONE' && !axes.includes(axisSel)) return false;
        }

        if (!q) return true;

        const axesStr = (flags.axes && flags.axes !== 'none') ? String(flags.axes) : '';
        const hay = norm([
          it.title,
          it.bookTitle,
          it.publicationTitle,
          it.conferenceName,
          it.publisher,
          it.place,
          it.isbn,
          it.doi,
          it.volume,
          it.issue,
          it.pages,
          axesStr,
          it.creatorsText
        ].filter(Boolean).join(' | '));

        return hay.includes(q);
      });

      $('sTotal').textContent = VIEW.length;
      $('sNeed').textContent = VIEW.filter(it => statusFor(it).txt === 'À traiter').length;
      $('sHal').textContent = VIEW.filter(it => it.flags?.hal_create === 'yes').length;
      $('sComms').textContent = VIEW.filter(it => it.flags?.comms_publish === 'yes').length;

      VIEW.sort((a,b) => {
        const ay = parseInt(a.year || '0', 10);
        const by = parseInt(b.year || '0', 10);
        if (by !== ay) return by - ay;
        return (b.date || '').localeCompare(a.date || '');
      });

      setPage(1);
    }

    function renderTable(){
      const tbody = $('rows');
      tbody.innerHTML = '';

      if (!VIEW.length){
        tbody.innerHTML = `<tr><td colspan="7" class="muted">Aucun résultat.</td></tr>`;
        return;
      }

      const start = (PAGE - 1) * PAGE_SIZE;
      const slice = VIEW.slice(start, start + PAGE_SIZE);

      for (const it of slice){
        const st = statusFor(it);
        const hal = tagYesNo(it.flags?.hal_create);
        const comms = tagYesNo(it.flags?.comms_publish);

        const halDone = it.flags?.hal_done === 'yes';
        const commDone = it.flags?.comms_done === 'yes';

        const halTxt = halDone ? 'Demandé (traité)' : (hal.txt === 'Oui' ? 'Demandé' : hal.txt);
        const commTxt = commDone ? 'Demandé (traité)' : (comms.txt === 'Oui' ? 'Demandé' : comms.txt);

        const title = it.title || '(sans titre)';
        const titleHtml = it.zoteroUrl
          ? `<a href="${it.zoteroUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a>`
          : escapeHtml(title);

        let extraMini = '';
        if (it.itemType === 'bookSection' && it.bookTitle) {
          extraMini += `<div class="mini">Dans : ${escapeHtml(it.bookTitle)}</div>`;
        } else if (it.itemType === 'journalArticle' && it.publicationTitle) {
          extraMini += `<div class="mini">Revue : ${escapeHtml(it.publicationTitle)}</div>`;
        } else if (it.itemType === 'conferencePaper' && it.conferenceName) {
          extraMini += `<div class="mini">Conférence : ${escapeHtml(it.conferenceName)}</div>`;
        }
        if (it.doi) extraMini += `<div class="mini">DOI : ${escapeHtml(it.doi)}</div>`;

        const axes = parseAxes(it.flags || {});
        const axesHtml = axes.length
          ? `<div class="axes">` + axes.map(a => `<span class="chip">${escapeHtml(a)}</span>`).join('') + `</div>`
          : '';

        const auth = clampAuthors(it.creatorsText || '');
        const authorsHtml = `<span class="authClamp" title="${escapeHtml(auth.full)}">${escapeHtml(auth.short)}</span>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="right">${escapeHtml(it.year || '')}</td>
          <td><span class="tag">${escapeHtml(typeLabel(it.itemType))}</span></td>
          <td class="title">${titleHtml}${extraMini}${axesHtml}</td>
          <td class="auth">${authorsHtml}</td>
          <td><span class="tag ${hal.cls}">${escapeHtml(halTxt)}</span></td>
          <td><span class="tag ${comms.cls}">${escapeHtml(commTxt)}</span></td>
          <td><span class="tag ${st.cls}">${escapeHtml(st.txt)}</span></td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function loadAdminItems(){
      $('msg').textContent = '';
      $('rows').innerHTML = `<tr><td colspan="7"><span class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Chargement…</span></td></tr>`;

      // IMPORTANT: on envoie le token Identity pour éviter 401 et “login cassé”
      const user = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      if (!user) {
        showLoggedOut();
        return;
      }
      const token = await user.jwt();

      try{
        const r = await fetch('/.netlify/functions/admin-items', {
          cache: 'no-store',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await r.json();

        if (!r.ok) {
          $('msg').textContent = (data && data.error) ? String(data.error) : 'Erreur côté serveur.';
          $('rows').innerHTML = `<tr><td colspan="7" class="muted">Erreur.</td></tr>`;
          return;
        }

        ALL = (data.items || []).map(it => {
          const y = it.year || yearFromDate(it.date);
          return {
            ...it,
            year: y || '',
            creatorsText: it.creatorsText || joinCreators(it.creators || []),
          };
        });

        fillYears(ALL);

        const ts = data.fetchedAt ? new Date(data.fetchedAt) : new Date();
        $('lastUpdate').textContent = `Maj : ${ts.toLocaleString('fr-FR')}`;

        applyFilters();
      } catch(err){
        console.error(err);
        $('msg').textContent = 'Erreur réseau.';
        $('rows').innerHTML = `<tr><td colspan="7" class="muted">Impossible de charger les données.</td></tr>`;
      }
    }

    // ------------------------------------------------------------
    // Init identity + listeners
    // ------------------------------------------------------------
    function wireUI(){
      $('loginBtn').addEventListener('click', openLogin);
      $('loginBtn2').addEventListener('click', openLogin);
      $('logoutBtn').addEventListener('click', logout);

      $('q').addEventListener('input', applyFilters);
      ['filterType','filterNeeds','filterAxis','filterYear'].forEach(id => $(id).addEventListener('change', applyFilters));

      $('reset').addEventListener('click', () => {
        $('q').value = '';
        $('filterType').value = 'all';
        $('filterNeeds').value = 'all';
        $('filterAxis').value = 'all';
        $('filterYear').value = 'all';
        applyFilters();
      });

      $('refresh').addEventListener('click', loadAdminItems);

      $('prev').addEventListener('click', () => setPage(PAGE - 1));
      $('next').addEventListener('click', () => setPage(PAGE + 1));
      $('pageSize').addEventListener('change', () => {
        const v = parseInt($('pageSize').value, 10);
        if (Number.isFinite(v) && v > 0 && v <= 500) {
          PAGE_SIZE = v;
          setPage(1);
        }
      });
    }

    function initIdentity(){
      if (!window.netlifyIdentity) {
        $('loginMsg').textContent = 'Netlify Identity non chargé.';
        showLoggedOut();
        return;
      }

      window.netlifyIdentity.on('init', user => {
        if (!user) {
          showLoggedOut();
        } else {
          showLoggedIn(user);
          loadAdminItems();
        }
      });

      window.netlifyIdentity.on('login', user => {
        showLoggedIn(user);
        window.netlifyIdentity.close();
        loadAdminItems();
      });

      window.netlifyIdentity.on('logout', () => {
        showLoggedOut();
      });

      window.netlifyIdentity.init();
    }

    wireUI();
    initIdentity();
  </script>
</body>
</html>
