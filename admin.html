<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Back-office ‚Äî Suivi HAL / Communication</title>
  <style>
    :root{
      --bg:#f5f5f8;--card:#fff;--text:#222;--muted:#666;--border:#ddd;
      --accent:#2c7be5;--ok:#1b7c3a;--warn:#b26a00;--bad:#b32020;
      --chip:#f2f6ff;--chip-border:#cfe0ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:1.45rem}
    .sub{margin:6px 0 0;color:var(--muted);font-size:.92rem}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:.85rem;color:var(--muted)}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}

    .controls{display:grid;grid-template-columns: 1.2fr 1fr 1fr 1fr auto;gap:10px}
    @media (max-width: 1100px){ .controls{grid-template-columns:1fr 1fr 1fr} }
    @media (max-width: 800px){ .controls{grid-template-columns:1fr 1fr} }
    @media (max-width: 520px){ .controls{grid-template-columns:1fr} }

    input,select,button{
      font:inherit;padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:#fff
    }
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:650}
    button.ghost{background:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.82rem;color:var(--muted);text-align:left;white-space:nowrap}
    td{font-size:.92rem}

    .title{font-weight:700}
    .muted{color:var(--muted)}
    .mini{font-size:.82rem}
    .right{white-space:nowrap}

    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;border:1px solid var(--border);
      font-size:.82rem;background:#fff;white-space:nowrap
    }
    .tag.ok{border-color:rgba(27,124,58,.35);background:rgba(27,124,58,.08);color:var(--ok)}
    .tag.warn{border-color:rgba(178,106,0,.35);background:rgba(178,106,0,.08);color:var(--warn)}
    .tag.bad{border-color:rgba(179,32,32,.35);background:rgba(179,32,32,.08);color:var(--bad)}

    .axes{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{
      display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;
      border:1px solid var(--chip-border);background:var(--chip);
      font-size:.78rem;font-weight:650;color:#1d3c76;white-space:nowrap;
    }

    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chk{display:flex;gap:8px;align-items:center}
    .chk input{transform:translateY(1px)}
    .statusline{margin-top:10px;color:var(--muted);font-size:.9rem;white-space:pre-wrap}

    /* ‚úÖ Auteurs : clamp pour √©viter que la colonne explose */
    td.authorsCol{max-width:230px;}
    td.authorsCol .clamp{
      display:-webkit-box;
      -webkit-line-clamp:2; /* 2 lignes max */
      -webkit-box-orient:vertical;
      overflow:hidden;
      text-overflow:ellipsis;
      word-break:break-word;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Back-office ‚Äî Suivi HAL & Communication</h1>
        <p class="sub">Connexion Netlify Identity requise. Les modifications sont enregistr√©es dans Zotero.</p>
      </div>
      <div class="pill" id="authPill">üîí Non connect√©</div>
    </header>

    <div class="bar">
      <div class="card" style="flex:1;min-width:320px">
        <div class="controls">
          <input id="q" type="search" placeholder="Rechercher (titre, auteur, revue, axes, √©diteur, ISBN, DOI‚Ä¶)" />
          <select id="filterNeed">
            <option value="all">Toutes demandes</option>
            <option value="needsAction">√Ä traiter</option>
            <option value="hal">HAL demand√©</option>
            <option value="comms">Com demand√©e</option>
          </select>
          <select id="filterType">
            <option value="all">Tous types</option>
            <option value="book">Livres</option>
            <option value="bookSection">Chapitres</option>
            <option value="journalArticle">Articles</option>
          </select>

          <select id="filterAxis">
            <option value="all">Tous axes</option>
            <option value="PICMAP">PICMAP</option>
            <option value="MOPTIS">MOPTIS</option>
            <option value="OCSO">OCSO</option>
            <option value="none">Sans axe</option>
          </select>

          <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
            <button class="ghost" id="login">Se connecter</button>
            <button class="ghost" id="logout">Se d√©connecter</button>
            <button class="primary" id="refresh">Rafra√Æchir</button>
          </div>
        </div>

        <div class="statusline" id="msg"></div>

        <table>
          <thead>
            <tr>
              <th style="width:80px">Ann√©e</th>
              <th style="width:90px">Type</th>
              <th>Titre</th>
              <th style="width:230px">Auteur(s)</th>
              <th style="width:170px">HAL</th>
              <th style="width:200px">Communication</th>
              <th style="width:210px">Actions</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="7" class="mini">Connecte-toi via Netlify Identity.</td></tr>
          </tbody>
        </table>

        <!-- ‚úÖ Pagination tableau (apr√®s filtrage) -->
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px">
          <div class="pill" id="pagerInfo">Page ‚Äî</div>

          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <label class="pill" style="gap:6px">
              Lignes/page
              <select id="pageSize" style="padding:6px 8px;border-radius:10px">
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </label>

            <button class="ghost" id="prevPage">‚óÄ Pr√©c√©dent</button>
            <button class="ghost" id="nextPage">Suivant ‚ñ∂</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    let ALL = [];
    let PAGE_INDEX = 0;
    let PAGE_SIZE = 25;

    const $ = (id) => document.getElementById(id);

    function norm(s){
      return (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }
    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }
    function typeLabel(t){
      if (t === 'book') return 'Livre';
      if (t === 'bookSection') return 'Chapitre';
      if (t === 'journalArticle') return 'Article';
      return t || '';
    }
    function yearFromDate(dateStr){
      const m = (dateStr || '').match(/\b(19|20)\d{2}\b/);
      return m ? m[0] : '';
    }

    function setMsg(s){ $('msg').textContent = s || ''; }

    function showAuthedUI(authed){
      $('authPill').textContent = authed ? '‚úÖ Connect√©' : 'üîí Non connect√©';
      $('login').style.display = authed ? 'none' : '';
      $('logout').style.display = authed ? '' : 'none';
      $('refresh').disabled = !authed;
      $('q').disabled = !authed;
      $('filterNeed').disabled = !authed;
      $('filterType').disabled = !authed;
      $('filterAxis').disabled = !authed;
      $('pageSize').disabled = !authed;
      $('prevPage').disabled = !authed;
      $('nextPage').disabled = !authed;
    }

    function parseAxes(flags){
      const raw = (flags && flags.axes) ? String(flags.axes).trim() : '';
      if (!raw || raw === 'none') return [];
      return raw.split(/[,;|]/).map(s => s.trim()).filter(Boolean).map(s => s.toUpperCase());
    }

    function statusFor(flags){
      const halWanted = flags.hal_create === 'yes';
      const commWanted = flags.comms_publish === 'yes';
      const halDone = flags.hal_done === 'yes';
      const commDone = flags.comms_done === 'yes';

      if (!halWanted && !commWanted) return { txt:'Non demand√©', cls:'' };

      const needHal = halWanted && !halDone;
      const needCom = commWanted && !commDone;

      if (needHal || needCom) return { txt:'√Ä traiter', cls:'warn' };
      return { txt:'Trait√©', cls:'ok' };
    }

    async function authedFetch(url, opts={}){
      const user = netlifyIdentity.currentUser();
      if (!user) throw new Error('Not logged in');
      const token = await user.jwt();
      const headers = Object.assign({}, opts.headers || {}, { Authorization: `Bearer ${token}` });
      return fetch(url, Object.assign({}, opts, { headers }));
    }

    function clampPageIndex(total){
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (PAGE_INDEX >= totalPages) PAGE_INDEX = totalPages - 1;
      if (PAGE_INDEX < 0) PAGE_INDEX = 0;
      return totalPages;
    }

    function updatePagerUI(total){
      const totalPages = clampPageIndex(total);
      const from = total ? (PAGE_INDEX * PAGE_SIZE + 1) : 0;
      const to = Math.min(total, (PAGE_INDEX + 1) * PAGE_SIZE);
      $('pagerInfo').textContent = `Page ${PAGE_INDEX + 1}/${totalPages} ‚Äî ${from}-${to} / ${total}`;
      $('prevPage').disabled = PAGE_INDEX <= 0;
      $('nextPage').disabled = PAGE_INDEX >= (totalPages - 1);
    }

    // ‚úÖ Chargement progressif: affiche vite 100 items puis charge le reste en arri√®re-plan
    async function load(){
      setMsg('‚è≥ Chargement‚Ä¶');
      $('rows').innerHTML = `<tr><td colspan="7" class="mini">Chargement‚Ä¶</td></tr>`;

      // 1) Premi√®re page rapide (100 max)
      const first = await authedFetch('/.netlify/functions/admin-items?start=0&limit=100');
      const data1 = await first.json().catch(()=>({}));

      if (!first.ok){
        setMsg('‚ùå Erreur: ' + (data1?.error || 'acc√®s refus√©'));
        $('rows').innerHTML = `<tr><td colspan="7" class="mini">Erreur serveur.</td></tr>`;
        return;
      }

      ALL = (data1.items || []).map(it => ({
        ...it,
        year: it.year || yearFromDate(it.date),
      }));

      PAGE_INDEX = 0;
      PAGE_SIZE = parseInt($('pageSize').value, 10) || 25;

      // Au tout d√©but, la recherche porte sur ce qui est charg√© (100).
      // D√®s que le reste arrive, on re-render => recherche sur tout.
      setMsg(`‚úÖ ${ALL.length} item(s) charg√©s (chargement partiel).`);
      render();

      // 2) Charger le reste en arri√®re-plan si n√©cessaire
      if (data1.hasMore && data1.nextStart !== null) {
        let nextStart = data1.nextStart;
        const limit = 100;

        setMsg(`‚è≥ Chargement du reste‚Ä¶ (${ALL.length}/${data1.totalResults || '‚Ä¶'})`);

        while (nextStart !== null) {
          const r = await authedFetch(`/.netlify/functions/admin-items?start=${nextStart}&limit=${limit}`);
          const d = await r.json().catch(()=>({}));
          if (!r.ok) break;

          const more = (d.items || []).map(it => ({
            ...it,
            year: it.year || yearFromDate(it.date),
          }));

          ALL.push(...more);

          setMsg(`‚è≥ Chargement du reste‚Ä¶ (${ALL.length}/${d.totalResults || '‚Ä¶'})`);
          nextStart = d.hasMore ? d.nextStart : null;
        }

        setMsg(`‚úÖ ${ALL.length} item(s) charg√©s. (sync: ${new Date(data1.fetchedAt).toLocaleString('fr-FR')})`);
        render();
      } else {
        setMsg(`‚úÖ ${ALL.length} item(s) charg√©s. (sync: ${new Date(data1.fetchedAt).toLocaleString('fr-FR')})`);
        render();
      }
    }

    function render(){
      const q = norm($('q').value);
      const fNeed = $('filterNeed').value;
      const fType = $('filterType').value;
      const fAxis = $('filterAxis').value; // ‚úÖ

      const rows = ALL.filter(it => {
        if (fType !== 'all' && it.itemType !== fType) return false;

        const flags = it.flags || {};
        const st = statusFor(flags);

        if (fNeed === 'needsAction' && st.txt !== '√Ä traiter') return false;
        if (fNeed === 'hal' && flags.hal_create !== 'yes') return false;
        if (fNeed === 'comms' && flags.comms_publish !== 'yes') return false;

        // ‚úÖ Filtre Axe
        const axes = parseAxes(flags);
        const axisSel = String(fAxis || 'all').toUpperCase();
        if (axisSel !== 'ALL') {
          if (axisSel === 'NONE' && axes.length) return false;
          if (axisSel !== 'NONE' && !axes.includes(axisSel)) return false;
        }

        if (!q) return true;

        const axesStr = (flags.axes && flags.axes !== 'none') ? String(flags.axes) : '';
        const hay = norm([
          it.title,
          it.bookTitle,
          it.publicationTitle,
          it.publisher,
          it.place,
          it.isbn,
          it.doi,
          it.volume,
          it.issue,
          it.pages,
          axesStr,
          it.creatorsText
        ].filter(Boolean).join(' | '));

        return hay.includes(q);
      });

      rows.sort((a,b) => {
        const ay = parseInt(a.year || '0',10);
        const by = parseInt(b.year || '0',10);
        if (by !== ay) return by - ay;
        return (b.date || '').localeCompare(a.date || '');
      });

      const tbody = $('rows');
      tbody.innerHTML = '';

      if (!rows.length){
        updatePagerUI(0);
        tbody.innerHTML = `<tr><td colspan="7" class="mini">Aucun r√©sultat.</td></tr>`;
        return;
      }

      updatePagerUI(rows.length);

      const startIdx = PAGE_INDEX * PAGE_SIZE;
      const endIdx = startIdx + PAGE_SIZE;
      const pageItems = rows.slice(startIdx, endIdx);

      for (const it of pageItems){
        const flags = it.flags || {};
        const st = statusFor(flags);

        const halWanted = flags.hal_create === 'yes';
        const commWanted = flags.comms_publish === 'yes';
        const halDone = flags.hal_done === 'yes';
        const commDone = flags.comms_done === 'yes';

        let infoTop = '';
        let infoBottom = '';

        if (it.itemType === 'bookSection' && it.bookTitle) {
          infoTop = `<div class="mini">Dans : ${escapeHtml(it.bookTitle)}</div>`;
        } else if (it.itemType === 'journalArticle' && it.publicationTitle) {
          infoTop = `<div class="mini">Revue : ${escapeHtml(it.publicationTitle)}</div>`;
        }

        if (it.itemType === 'journalArticle') {
          const parts = [];
          if (it.volume) parts.push('vol. ' + escapeHtml(it.volume));
          if (it.issue) parts.push('n¬∞ ' + escapeHtml(it.issue));
          if (it.pages) parts.push('pp. ' + escapeHtml(it.pages));
          if (it.doi) parts.push('DOI ' + escapeHtml(it.doi));
          infoBottom = parts.length ? `<div class="mini">${parts.join(' ‚Äî ')}</div>` : '';
        } else {
          const parts = [];
          if (it.publisher) parts.push(escapeHtml(it.publisher));
          if (it.place) parts.push(escapeHtml(it.place));
          if (it.isbn) parts.push('ISBN ' + escapeHtml(it.isbn));
          infoBottom = parts.length ? `<div class="mini">${parts.join(' ‚Äî ')}</div>` : '';
        }

        const axes = parseAxes(flags);
        const axesHtml = axes.length
          ? `<div class="axes">` + axes.map(a => `<span class="chip">${escapeHtml(a)}</span>`).join('') + `</div>`
          : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="right">${escapeHtml(it.year || '')}</td>
          <td><span class="tag">${escapeHtml(typeLabel(it.itemType))}</span></td>
          <td>
            <div class="title">${escapeHtml(it.title || '(sans titre)')}</div>
            ${infoTop}
            ${infoBottom}
            ${axesHtml}
          </td>
          <td class="authorsCol">
            <div class="clamp" title="${escapeHtml(it.creatorsText || '')}">${escapeHtml(it.creatorsText || '')}</div>
          </td>

          <td>
            <div class="tag ${halWanted ? 'warn' : ''}">
              ${halWanted ? (halDone ? 'Demand√© (trait√©)' : 'Demand√©') : 'Non'}
            </div>
            ${halWanted ? `
              <div class="chk mini" style="margin-top:8px">
                <input type="checkbox" data-k="${it.key}" data-field="hal_done" ${halDone ? 'checked' : ''}/>
                <span>HAL trait√©</span>
              </div>
            ` : `<div class="mini muted">‚Äî</div>`}
          </td>

          <td>
            <div class="tag ${commWanted ? 'warn' : ''}">
              ${commWanted ? (commDone ? 'Demand√© (trait√©)' : 'Demand√©') : 'Non'}
            </div>
            ${commWanted ? `
              <div class="chk mini" style="margin-top:8px">
                <input type="checkbox" data-k="${it.key}" data-field="comms_done" ${commDone ? 'checked' : ''}/>
                <span>Com trait√©e</span>
              </div>
            ` : `<div class="mini muted">‚Äî</div>`}
          </td>

          <td>
            <div class="actions">
              <button class="primary" data-save="${it.key}">Enregistrer</button>
              <span class="tag ${st.cls}">${escapeHtml(st.txt)}</span>
            </div>
            <div class="mini muted">Key: ${escapeHtml(it.key)}</div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // Bind actions
      tbody.querySelectorAll('button[data-save]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const key = btn.getAttribute('data-save');
          await saveRow(key, btn);
        });
      });
    }

    async function saveRow(key, btn){
      const checks = [...document.querySelectorAll(`input[type="checkbox"][data-k="${key}"]`)];
      const payload = { key };
      for (const c of checks){
        const field = c.getAttribute('data-field');
        payload[field] = c.checked ? 'yes' : 'no';
      }

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Enregistrement‚Ä¶';
      setMsg('‚è≥ Mise √† jour Zotero‚Ä¶');

      try{
        const r = await authedFetch('/.netlify/functions/admin-update-status', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=>({}));

        if (!r.ok){
          setMsg('‚ùå Erreur: ' + (data?.error || 'mise √† jour impossible'));
        } else {
          setMsg('‚úÖ Mis √† jour. Rechargement‚Ä¶');
          await load();
        }
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    $('login').addEventListener('click', () => netlifyIdentity.open());
    $('logout').addEventListener('click', () => netlifyIdentity.logout());
    $('refresh').addEventListener('click', load);

    // ‚úÖ listeners robustes : reset page + render
    $('q').addEventListener('input', () => { PAGE_INDEX = 0; render(); });
    ['filterNeed','filterType','filterAxis'].forEach(id => $(id).addEventListener('change', () => { PAGE_INDEX = 0; render(); }));

    // Pagination tableau
    $('pageSize').addEventListener('change', () => {
      PAGE_SIZE = parseInt($('pageSize').value, 10) || 25;
      PAGE_INDEX = 0;
      render();
    });
    $('prevPage').addEventListener('click', () => {
      PAGE_INDEX--;
      render();
    });
    $('nextPage').addEventListener('click', () => {
      PAGE_INDEX++;
      render();
    });

    netlifyIdentity.on('init', user => {
      showAuthedUI(!!user);
      updatePagerUI(0);
      setMsg(user ? '‚úÖ Connect√©. Clique ‚ÄúRafra√Æchir‚Äù.' : 'üîí Non connect√©.');
    });

    netlifyIdentity.on('login', user => {
      showAuthedUI(true);
      netlifyIdentity.close();
      setMsg('‚úÖ Connect√©. Chargement‚Ä¶');
      load();
    });

    netlifyIdentity.on('logout', () => {
      showAuthedUI(false);
      ALL = [];
      updatePagerUI(0);
      $('rows').innerHTML = `<tr><td colspan="7" class="mini">D√©connect√©.</td></tr>`;
      setMsg('üîí D√©connect√©.');
    });

    netlifyIdentity.init();
  </script>
</body>
</html>
